# DBãƒ»ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šãƒ»æ¥ç¶šè©³ç´°ã‚¬ã‚¤ãƒ‰ (v1.0.0)

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®šã¨ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã®æ¥ç¶šã«é–¢ã™ã‚‹è©³ç´°ãªæ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚100äººã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒåŒã˜ã‚ˆã†ã«å†ç¾ã§ãã‚‹ã‚ˆã†ã€å…·ä½“çš„ã‹ã¤æ˜ç¢ºãªæ‰‹é †ã‚’æä¾›ã—ã¾ã™ã€‚

> **æ³¨æ„**: æœ¬ã‚¬ã‚¤ãƒ‰ã¯2023å¹´12æœˆæ™‚ç‚¹ã®æƒ…å ±ã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚

## ç›®æ¬¡

1. [å‰ææ¡ä»¶](#1-å‰ææ¡ä»¶)
2. [Cloudflareãƒªã‚½ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—](#2-cloudflareãƒªã‚½ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©](#3-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³](#4-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³)
5. [ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…](#5-ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…)
6. [ç’°å¢ƒå¤‰æ•°ã®è¨­å®š](#6-ç’°å¢ƒå¤‰æ•°ã®è¨­å®š)
7. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ](#7-ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ)
8. [åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥](#8-åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥)
9. [æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š](#9-æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®š)
10. [ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](#10-ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°)

## 1. å‰ææ¡ä»¶

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚¤ãƒ³ãƒ•ãƒ©è¨­å®šã‚’é€²ã‚ã‚‹å‰ã«ã€ä»¥ä¸‹ã®å‰ææ¡ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

### å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

| ãƒ„ãƒ¼ãƒ«/ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ    | å¿…è¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³ | ç¢ºèªæ–¹æ³•                                                | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•                                    |
| -------------------- | -------------- | ------------------------------------------------------- | --------------------------------------------------- |
| Node.js              | v20.10.0ä»¥ä¸Š   | `node -v`                                               | [å…¬å¼ã‚µã‚¤ãƒˆ](https://nodejs.org/) ã¾ãŸã¯ nvm        |
| pnpm                 | v8.10.0ä»¥ä¸Š    | `pnpm -v`                                               | `pnpm install -g pnpm`                              |
| wrangler CLI         | v3.15.0ä»¥ä¸Š    | `wrangler -v`                                           | `pnpm add -g wrangler`                              |
| Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆ | -              | [dashboard.cloudflare.com](https://dash.cloudflare.com) | [ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—](https://dash.cloudflare.com/sign-up) |

### ç¢ºèªæ‰‹é †

```bash
# Node.jsã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
node -v  # v20.10.0ä»¥ä¸ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

# pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨ç¢ºèª
pnpm install -g pnpm@latest
pnpm -v  # 8.10.0ä»¥ä¸ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

# wranglerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -g wrangler@latest
wrangler -v  # 3.15.0ä»¥ä¸ŠãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨

# Cloudflareã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
wrangler login
# ãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ãã€èªè¨¼ã‚’æ±‚ã‚ã‚‰ã‚Œã¾ã™
# èªè¨¼å®Œäº†å¾Œã€ŒYou have successfully logged in.ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
```

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæº–å‚™çŠ¶æ³ã®ç¢ºèª

- ãƒªãƒã‚¸ãƒˆãƒªãŒã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- åŸºæœ¬çš„ãªé–‹ç™ºç’°å¢ƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨
- Next.jsãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨

å‰ææ¡ä»¶ãŒæº€ãŸã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€å…ˆã«[åˆæœŸè¨­å®šã‚¬ã‚¤ãƒ‰](./initial_setup_guide.md)ã®æ‰‹é †ã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚

## 2. Cloudflareãƒªã‚½ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

Cloudflareãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šã§å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¾ã™ã€‚

### D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ

D1ã¯Cloudflareã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹SQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã€Workersã‹ã‚‰ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

```bash
# D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä½œæˆ
wrangler d1 create automationa-tools-db

# å‡ºåŠ›ä¾‹:
# Created database 'automationa-tools-db' (xxxx-xxxx-xxxx-xxxx)
# [[d1_databases]]
# binding = "DB"
# database_name = "automationa-tools-db"
# database_id = "xxxx-xxxx-xxxx-xxxx"

# âš ï¸ é‡è¦: ã“ã®å‡ºåŠ›ã‹ã‚‰database_idã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã
# ä¾‹: D1_DATABASE_ID=xxxx-xxxx-xxxx-xxxx
```

### KVãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆ

KVã¯Cloudflareã®ã‚­ãƒ¼ãƒãƒªãƒ¥ãƒ¼ã‚¹ãƒˆã‚¢ã§ã€é«˜é€Ÿãªèª­ã¿å–ã‚Šã‚¢ã‚¯ã‚»ã‚¹ã«é©ã—ã¦ã„ã¾ã™ã€‚

```bash
# KVãƒãƒ¼ãƒ ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆ
wrangler kv:namespace create automationa-tools-cache

# å‡ºåŠ›ä¾‹:
# Add the following to your configuration file:
# [[kv_namespaces]]
# binding = "automationa-tools-cache"
# id = "xxxx-xxxx-xxxx-xxxx"

# âš ï¸ é‡è¦: ã“ã®å‡ºåŠ›ã‹ã‚‰idã‚’ãƒ¡ãƒ¢ã—ã¦ãŠã
# ä¾‹: KV_NAMESPACE_ID=xxxx-xxxx-xxxx-xxxx
```

### R2ãƒã‚±ãƒƒãƒˆã®ä½œæˆ

R2ã¯Cloudflareã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ã€S3äº’æ›ã®APIã‚’æä¾›ã—ã¾ã™ã€‚

```bash
# R2ãƒã‚±ãƒƒãƒˆã®ä½œæˆ
wrangler r2 bucket create automationa-tools-storage

# å‡ºåŠ›ä¾‹:
# Created bucket 'automationa-tools-storage'
# Add the following to your wrangler.toml file:
# [[r2_buckets]]
# binding = "STORAGE"
# bucket_name = "automationa-tools-storage"
```

### wrangler.tomlã®è¨­å®š

ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’å‚ç…§ã™ã‚‹ãŸã‚ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# wrangler.tomlãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
cat > wrangler.toml << EOL
name = "automationa-tools-application"
compatibility_date = "2023-12-01"
main = "src/worker.ts"

# D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
[[d1_databases]]
binding = "DB"
database_name = "automationa-tools-db"
database_id = "${D1_DATABASE_ID}"  # å…ˆã»ã©ãƒ¡ãƒ¢ã—ãŸIDã«ç½®ãæ›ãˆã‚‹

# KVè¨­å®š
[[kv_namespaces]]
binding = "KV_CACHE"
id = "${KV_NAMESPACE_ID}"  # å…ˆã»ã©ãƒ¡ãƒ¢ã—ãŸIDã«ç½®ãæ›ãˆã‚‹

# R2ãƒã‚±ãƒƒãƒˆè¨­å®š
[[r2_buckets]]
binding = "STORAGE"
bucket_name = "automationa-tools-storage"

# ç’°å¢ƒå¤‰æ•°è¨­å®š
[vars]
ENVIRONMENT = "production"

# é–‹ç™ºç’°å¢ƒå‘ã‘
[env.development]
workers_dev = true
[env.development.vars]
ENVIRONMENT = "development"

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒå‘ã‘
[env.staging]
[env.staging.vars]
ENVIRONMENT = "staging"
EOL
```

> âš ï¸ **é‡è¦**: `${D1_DATABASE_ID}`ã¨`${KV_NAMESPACE_ID}`ã‚’ã€å…ˆã»ã©ãƒ¡ãƒ¢ã—ãŸå®Ÿéš›ã®IDã«å¿…ãšç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

### ãƒªã‚½ãƒ¼ã‚¹è¨­å®šã®ç¢ºèª

```bash
# D1æ¥ç¶šãƒ†ã‚¹ãƒˆ
wrangler d1 execute automationa-tools-db --command "SELECT 1+1 as result"
# å‡ºåŠ›ä¾‹: { result: 2 }

# KVå‹•ä½œãƒ†ã‚¹ãƒˆ
wrangler kv key put --namespace-id=automationa-tools-cache "test-key" "test-value"
# å‡ºåŠ›ä¾‹: test-value

# ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆç¢ºèª
ls -la
# wrangler.tomlãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
```

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

Drizzle ORMã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ

```bash
# ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ä½œæˆ - æ©Ÿèƒ½åˆ¥ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p src/infrastructure/database/drizzle/[feature]
mkdir -p src/infrastructure/database/repositories/[feature]
mkdir -p src/infrastructure/database/queryBuilders/[feature]

# å®Ÿè£…ä¾‹ã¨ã—ã¦ã€useræ©Ÿèƒ½ã¨taskæ©Ÿèƒ½ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir -p src/infrastructure/database/drizzle/user
mkdir -p src/infrastructure/database/drizzle/task
mkdir -p src/infrastructure/database/repositories/user
mkdir -p src/infrastructure/database/repositories/task
mkdir -p src/infrastructure/database/queryBuilders/user
mkdir -p src/infrastructure/database/queryBuilders/task
```

### ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ
cat > src/infrastructure/database/drizzle/user/schema.ts << 'EOL'
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { createId } from '@paralleldrive/cuid2';

export const users = sqliteTable('users', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  email: text('email').notNull().unique(),
  name: text('name').notNull(),
  password: text('password').notNull(),
  role: text('role', { enum: ['user', 'admin'] }).default('user').notNull(),
  createdAt: integer('created_at', { mode: 'timestamp' })
    .$defaultFn(() => new Date())
    .notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' })
    .$defaultFn(() => new Date())
    .notNull(),
});

// å‹å®šç¾©
export type User = typeof users.$inferSelect;
export type NewUser = typeof users.$inferInsert;
EOL
```

#### ã‚¿ã‚¹ã‚¯ã‚¹ã‚­ãƒ¼ãƒ

```bash
# ã‚¿ã‚¹ã‚¯ã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ
cat > src/infrastructure/database/drizzle/task/schema.ts << 'EOL'
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { createId } from '@paralleldrive/cuid2';
import { users } from '../user/schema';

export const tasks = sqliteTable('tasks', {
  id: text('id').primaryKey().$defaultFn(() => createId()),
  title: text('title').notNull(),
  description: text('description'),
  status: text('status', { enum: ['todo', 'in_progress', 'done'] }).default('todo').notNull(),
  priority: integer('priority').default(0).notNull(),
  userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
  createdAt: integer('created_at', { mode: 'timestamp' })
    .$defaultFn(() => new Date())
    .notNull(),
  updatedAt: integer('updated_at', { mode: 'timestamp' })
    .$defaultFn(() => new Date())
    .notNull(),
});

// å‹å®šç¾©
export type Task = typeof tasks.$inferSelect;
export type NewTask = typeof tasks.$inferInsert;
EOL
```

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«

```bash
# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
cat > src/infrastructure/database/drizzle/index.ts << 'EOL'
export * from './user/schema';
export * from './task/schema';
EOL

# ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add @paralleldrive/cuid2
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
# ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cat > src/infrastructure/database/drizzle/client.ts << 'EOL'
import { drizzle } from 'drizzle-orm/d1';
import { D1Database } from '@cloudflare/workers-types';
import * as schema from './index';

/**
 * D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹é–¢æ•°
 *
 * @param d1 Cloudflare D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @returns Drizzle ORMã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 */
export function getDbClient(d1: D1Database) {
  return drizzle(d1, { schema });
}
EOL

# D1å‹å®šç¾©ã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D @cloudflare/workers-types
```

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šã‚’è¡Œã„ã¾ã™ã€‚

### Drizzleè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
# drizzle.config.tsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆ
cat > drizzle.config.ts << 'EOL'
import { defineConfig } from 'drizzle-kit';
import * as dotenv from 'dotenv';

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
dotenv.config({ path: '.env.local' });

export default defineConfig({
  schema: './src/infrastructure/database/drizzle/**/schema.ts',
  out: './drizzle',
  driver: 'd1',
  dbCredentials: {
    wranglerConfigPath: './wrangler.toml',
    dbName: 'DB',
  },
  verbose: true,
  strict: true,
});
EOL

# dotenvã®ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D dotenv
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
pnpm drizzle-kit generate

# å‡ºåŠ›ä¾‹:
# Generating migration for D1 driver
# Including following files into migration:
# - ./src/infrastructure/database/drizzle/schema/users.ts
# - ./src/infrastructure/database/drizzle/schema/tasks.ts
#
# Migration generated at: drizzle/0000_initial.sql ğŸš€

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
cat drizzle/0000_initial.sql
# SQLãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é©ç”¨

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é©ç”¨
pnpm wrangler d1 execute automationa-tools-db --file=./drizzle/0000_initial.sql

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
# ä¾‹: Successfully executed X commands from ./drizzle/0000_initial.sql on automationa-tools-db.
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
mkdir -p scripts
cat > scripts/migrate.js << 'EOL'
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹
const MIGRATIONS_DIR = path.resolve(__dirname, '../drizzle');

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å
const DB_NAME = 'automationa-tools-db';

// ã™ã¹ã¦ã®SQLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦æ˜‡é †ã«ã‚½ãƒ¼ãƒˆ
const sqlFiles = fs.readdirSync(MIGRATIONS_DIR)
  .filter(file => file.endsWith('.sql'))
  .sort();

if (sqlFiles.length === 0) {
  console.error('âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã¾ãš `pnpm drizzle-kit generate` ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
  process.exit(1);
}

console.log(`ğŸ” ${sqlFiles.length}å€‹ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™...`);

// å„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œ
for (const file of sqlFiles) {
  const filePath = path.join(MIGRATIONS_DIR, file);
  console.log(`âš™ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­: ${file}`);

  try {
    // wranglerã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
    execSync(`pnpm wrangler d1 execute ${DB_NAME} --file=${filePath}`, {
      stdio: 'inherit'
    });
    console.log(`âœ… ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ: ${file}`);
  } catch (error) {
    console.error(`âŒ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: ${file}`);
    console.error(error.message);
    process.exit(1);
  }
}

console.log('ğŸ‰ ã™ã¹ã¦ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼');
EOL

# package.jsonã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ï¼ˆpackage.jsonã‚’ç·¨é›†ï¼‰
# ã‚¹ã‚¯ãƒªãƒ—ãƒˆéƒ¨åˆ†ã«ä»¥ä¸‹ã‚’è¿½åŠ :
# "db:generate": "drizzle-kit generate",
# "db:migrate": "node scripts/migrate.js",
# "db:studio": "drizzle-kit studio"
```

## 5. ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ã‚¯ã‚»ã‚¹ã‚’æŠ½è±¡åŒ–ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### ãƒªãƒã‚¸ãƒˆãƒªåŸºåº•ã‚¯ãƒ©ã‚¹ã®ä½œæˆ

```bash
# ãƒªãƒã‚¸ãƒˆãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«åŸºåº•ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ
cat > src/infrastructure/database/repositories/base-repository.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { eq } from 'drizzle-orm';
import { getDbClient } from '../drizzle/client';
import { SQLiteTableWithColumns } from 'drizzle-orm/sqlite-core';

/**
 * æ±ç”¨ãƒªãƒã‚¸ãƒˆãƒªåŸºåº•ã‚¯ãƒ©ã‚¹
 * ã™ã¹ã¦ã®ãƒªãƒã‚¸ãƒˆãƒªã®å…±é€šæ©Ÿèƒ½ã‚’æä¾›
 */
export abstract class BaseRepository<T, TableType extends SQLiteTableWithColumns<{
  name: string;
  schema: string;
  columns: Record<string, unknown>;
}>> {
  protected db: ReturnType<typeof getDbClient>;

  constructor(protected d1: D1Database) {
    this.db = getDbClient(d1);
  }

  /**
   * ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’æä¾›ã™ã‚‹æŠ½è±¡ãƒ¡ã‚½ãƒƒãƒ‰
   * ç¶™æ‰¿å…ˆã§å®Ÿè£…ã™ã‚‹å¿…è¦ã‚ã‚Š
   */
  protected abstract get table(): TableType;

  /**
   * IDã«ã‚ˆã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
   *
   * @param id ãƒ¬ã‚³ãƒ¼ãƒ‰ID
   * @returns è¦‹ã¤ã‹ã£ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯null
   */
  async findById(id: string): Promise<T | null> {
    const result = await this.db
      .select()
      .from(this.table)
      .where(eq(this.table.id, id))
      .get();

    return result || null;
  }

  /**
   * å…¨ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
   *
   * @returns ãƒ¬ã‚³ãƒ¼ãƒ‰ã®é…åˆ—
   */
  async findAll(): Promise<T[]> {
    return await this.db
      .select()
      .from(this.table)
      .all();
  }

  /**
   * ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
   *
   * @param data ä½œæˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿
   * @returns ä½œæˆã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰
   */
  async create(data: Omit<T, 'id' | 'createdAt' | 'updatedAt'>): Promise<T> {
    const result = await this.db
      .insert(this.table)
      .values(data as unknown as Record<string, unknown>)
      .returning()
      .get();

    return result;
  }

  /**
   * ãƒ¬ã‚³ãƒ¼ãƒ‰æ›´æ–°
   *
   * @param id æ›´æ–°å¯¾è±¡ã®ID
   * @param data æ›´æ–°ãƒ‡ãƒ¼ã‚¿
   * @returns æ›´æ–°ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã¾ãŸã¯null
   */
  async update(id: string, data: Partial<Omit<T, 'id' | 'createdAt'>>): Promise<T | null> {
    const updated = {
      ...data,
      updatedAt: new Date(),
    };

    const result = await this.db
      .update(this.table)
      .set(updated as unknown as Record<string, unknown>)
      .where(eq(this.table.id, id))
      .returning()
      .get();

    return result || null;
  }

  /**
   * ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤
   *
   * @param id å‰Šé™¤å¯¾è±¡ã®ID
   * @returns å‰Šé™¤æˆåŠŸæ™‚trueã€å¤±æ•—æ™‚false
   */
  async delete(id: string): Promise<boolean> {
    const result = await this.db
      .delete(this.table)
      .where(eq(this.table.id, id))
      .returning()
      .get();

    return !!result;
  }
}
EOL
```

### æ©Ÿèƒ½åˆ¥ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…

ãƒªãƒã‚¸ãƒˆãƒªã‚¯ãƒ©ã‚¹ã¯æ©Ÿèƒ½([feature])ã”ã¨ã«å®Ÿè£…ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã¨ã‚¿ã‚¹ã‚¯æ©Ÿèƒ½ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ä¾‹

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…
cat > src/infrastructure/database/repositories/user/index.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { eq } from 'drizzle-orm';
import { BaseRepository } from '../base-repository';
import { users, User, NewUser } from '../../drizzle/user/schema';

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®æ°¸ç¶šåŒ–ã‚’æ‹…å½“ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª
 */
export class UserRepository extends BaseRepository<User, typeof users> {
  constructor(d1: D1Database) {
    super(d1);
  }

  /**
   * ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®å–å¾—
   */
  protected get table() {
    return users;
  }

  /**
   * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
   *
   * @param email ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   * @returns è¦‹ã¤ã‹ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯null
   */
  async findByEmail(email: string): Promise<User | null> {
    const result = await this.db
      .select()
      .from(users)
      .where(eq(users.email, email))
      .get();

    return result || null;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã®å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
   *
   * @param userData ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
   * @returns ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼
   */
  async createUser(userData: Omit<NewUser, 'id' | 'createdAt' | 'updatedAt'>): Promise<User> {
    return await this.create(userData);
  }
}
EOL
```

#### ã‚¿ã‚¹ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…ä¾‹

```bash
# ã‚¿ã‚¹ã‚¯ãƒªãƒã‚¸ãƒˆãƒªã®å®Ÿè£…
cat > src/infrastructure/database/repositories/task/index.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { eq, and, desc, asc } from 'drizzle-orm';
import { BaseRepository } from '../base-repository';
import { tasks, Task, NewTask } from '../../drizzle/task/schema';

/**
 * ã‚¿ã‚¹ã‚¯æƒ…å ±ã®æ°¸ç¶šåŒ–ã‚’æ‹…å½“ã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª
 */
export class TaskRepository extends BaseRepository<Task, typeof tasks> {
  constructor(d1: D1Database) {
    super(d1);
  }

  /**
   * ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã®å–å¾—
   */
  protected get table() {
    return tasks;
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯æ¤œç´¢
   *
   * @param userId ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
   * @returns ã‚¿ã‚¹ã‚¯ã®é…åˆ—
   */
  async findByUserId(userId: string): Promise<Task[]> {
    return await this.db
      .select()
      .from(tasks)
      .where(eq(tasks.userId, userId))
      .orderBy(desc(tasks.updatedAt))
      .all();
  }

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ã‚¿ã‚¹ã‚¯æ¤œç´¢
   *
   * @param userId ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
   * @param status ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns ã‚¿ã‚¹ã‚¯ã®é…åˆ—
   */
  async findByStatus(userId: string, status: Task['status']): Promise<Task[]> {
    return await this.db
      .select()
      .from(tasks)
      .where(
        and(
          eq(tasks.userId, userId),
          eq(tasks.status, status)
        )
      )
      .orderBy(asc(tasks.priority), desc(tasks.updatedAt))
      .all();
  }

  /**
   * ã‚¿ã‚¹ã‚¯ä½œæˆã®å°‚ç”¨ãƒ¡ã‚½ãƒƒãƒ‰
   *
   * @param taskData ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
   * @returns ä½œæˆã•ã‚ŒãŸã‚¿ã‚¹ã‚¯
   */
  async createTask(taskData: Omit<NewTask, 'id' | 'createdAt' | 'updatedAt'>): Promise<Task> {
    return await this.create(taskData);
  }

  /**
   * ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ›´æ–°
   *
   * @param id ã‚¿ã‚¹ã‚¯ID
   * @param status æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns æ›´æ–°ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯
   */
  async updateStatus(id: string, status: Task['status']): Promise<Task | null> {
    return await this.update(id, { status });
  }
}
EOL
```

### ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > src/infrastructure/database/repositories/index.ts << 'EOL'
export * from './user';
export * from './task';
EOL

# ä¸è¶³ã—ã¦ã„ã‚‹ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add drizzle-orm@0.29.0
```

### æ©Ÿèƒ½åˆ¥ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…

ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã‚‚æ©Ÿèƒ½([feature])ã”ã¨ã«å®Ÿè£…ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ©Ÿèƒ½ã¨ã‚¿ã‚¹ã‚¯æ©Ÿèƒ½ã®å®Ÿè£…ä¾‹ã§ã™ã€‚

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…ä¾‹

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…
cat > src/infrastructure/database/queryBuilders/user/index.ts << 'EOL'
import { SQLiteTableWithColumns } from 'drizzle-orm/sqlite-core';
import { eq, and, like } from 'drizzle-orm';
import { users, User } from '../../drizzle/user/schema';

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
 * è¤‡é›‘ãªã‚¯ã‚¨ãƒªæ¡ä»¶ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
export class UserQueryBuilder {
  /**
   * ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param email ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static byEmail(email: string) {
    return eq(users.email, email);
  }

  /**
   * ãƒ­ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param role ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static byRole(role: User['role']) {
    return eq(users.role, role);
  }

  /**
   * åå‰ã®éƒ¨åˆ†ä¸€è‡´ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param name åå‰ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static nameContains(name: string) {
    return like(users.name, `%${name}%`);
  }
}
EOL
```

#### ã‚¿ã‚¹ã‚¯ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…ä¾‹

```bash
# ã‚¿ã‚¹ã‚¯ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®å®Ÿè£…
cat > src/infrastructure/database/queryBuilders/task/index.ts << 'EOL'
import { SQLiteTableWithColumns } from 'drizzle-orm/sqlite-core';
import { eq, and, like, gt, lt, between } from 'drizzle-orm';
import { tasks, Task } from '../../drizzle/task/schema';

/**
 * ã‚¿ã‚¹ã‚¯æ¤œç´¢ç”¨ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼
 * è¤‡é›‘ãªã‚¯ã‚¨ãƒªæ¡ä»¶ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 */
export class TaskQueryBuilder {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param userId ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static byUserId(userId: string) {
    return eq(tasks.userId, userId);
  }

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param status ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static byStatus(status: Task['status']) {
    return eq(tasks.status, status);
  }

  /**
   * ã‚¿ã‚¤ãƒˆãƒ«ã®éƒ¨åˆ†ä¸€è‡´ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param title ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆéƒ¨åˆ†ä¸€è‡´ï¼‰
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static titleContains(title: string) {
    return like(tasks.title, `%${title}%`);
  }

  /**
   * å„ªå…ˆåº¦ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’æ§‹ç¯‰
   *
   * @param min æœ€å°å„ªå…ˆåº¦
   * @param max æœ€å¤§å„ªå…ˆåº¦
   * @returns ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶
   */
  static byPriorityRange(min: number, max: number) {
    return between(tasks.priority, min, max);
  }
}
EOL
```

### ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

```bash
# ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > src/infrastructure/database/queryBuilders/index.ts << 'EOL'
export * from './user';
export * from './task';
EOL
```

## 6. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§å¿…è¦ãªç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™ã€‚

### ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

```bash
# .env.exampleãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
cat > .env.example << 'EOL'
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_BASE_URL=/api

# Cloudflare - å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹å¿…è¦ã‚ã‚Š
CF_ACCOUNT_ID=your_cloudflare_account_id
CF_API_TOKEN=your_cloudflare_api_token

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ - å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹å¿…è¦ã‚ã‚Š
D1_DATABASE_ID=your_d1_database_id
KV_NAMESPACE_ID=your_kv_namespace_id
R2_BUCKET_NAME=automationa-tools-storage

# èªè¨¼ - å®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹å¿…è¦ã‚ã‚Š
AUTH_SECRET=your_auth_secret_min_32_chars
JWT_SECRET=your_jwt_secret_min_32_chars
EOL

# .env.localãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆï¼ˆå®Ÿéš›ã®å€¤ã«ç½®ãæ›ãˆã‚‹å¿…è¦ã‚ã‚Šï¼‰
cat > .env.local << 'EOL'
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_BASE_URL=/api

# Cloudflare - å®Ÿéš›ã®å€¤ã§ç½®ãæ›ãˆã¦ãã ã•ã„
CF_ACCOUNT_ID=your_cloudflare_account_id
CF_API_TOKEN=your_cloudflare_api_token

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ - å®Ÿéš›ã®å€¤ã§ç½®ãæ›ãˆã¦ãã ã•ã„
D1_DATABASE_ID=your_d1_database_id
KV_NAMESPACE_ID=your_kv_namespace_id
R2_BUCKET_NAME=automationa-tools-storage

# èªè¨¼ - å®‰å…¨ãªãƒ©ãƒ³ãƒ€ãƒ å€¤ã‚’ç”Ÿæˆï¼ˆä»¥ä¸‹ã¯ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚å¿…ãšç½®ãæ›ãˆã¦ãã ã•ã„ï¼‰
AUTH_SECRET=b9e74d7c8f3a6e2516b5d7a9f0c1e8a7d6b3c9e0
JWT_SECRET=c7a4e9d0b3f2a5c1e8a7d6b3c9e0f8a5d1b6c3e7
EOL
```

> âš ï¸ **é‡è¦**: `.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å®Ÿéš›ã®å€¤ã‚’è¨­å®šã—ã€Gitã«ã¯çµ¶å¯¾ã«ã‚³ãƒŸãƒƒãƒˆã—ãªã„ã§ãã ã•ã„ã€‚

### ç’°å¢ƒå¤‰æ•°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ

```bash
# ç’°å¢ƒå¤‰æ•°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ
mkdir -p src/lib/config
cat > src/lib/config/env.ts << 'EOL'
/**
 * ç’°å¢ƒå¤‰æ•°ã‚’å®‰å…¨ã«å–å¾—ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 * å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼
 */
export function getEnv(key: string, defaultValue?: string): string {
  const value = process.env[key] || defaultValue;

  if (value === undefined) {
    throw new Error(`å¿…é ˆç’°å¢ƒå¤‰æ•° "${key}" ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
  }

  return value;
}

/**
 * ç’°å¢ƒå¤‰æ•°ã®ãƒ–ãƒ¼ãƒ«å€¤ã‚’å–å¾—
 */
export function getBoolEnv(key: string, defaultValue = false): boolean {
  const value = process.env[key];

  if (value === undefined) {
    return defaultValue;
  }

  return value === '1' || value === 'true' || value === 'yes';
}

/**
 * ç’°å¢ƒå¤‰æ•°ã®æ•°å€¤ã‚’å–å¾—
 */
export function getNumEnv(key: string, defaultValue?: number): number {
  const value = process.env[key];

  if (value === undefined) {
    if (defaultValue === undefined) {
      throw new Error(`å¿…é ˆç’°å¢ƒå¤‰æ•° "${key}" ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`);
    }
    return defaultValue;
  }

  const num = Number(value);
  if (isNaN(num)) {
    throw new Error(`ç’°å¢ƒå¤‰æ•° "${key}" ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${value}`);
  }

  return num;
}

/**
 * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒå¤‰æ•°ã‚’é›†ç´„
 */
export const env = {
  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
  appUrl: getEnv('NEXT_PUBLIC_APP_URL', 'http://localhost:3000'),
  apiBaseUrl: getEnv('NEXT_PUBLIC_API_BASE_URL', '/api'),
  nodeEnv: getEnv('NODE_ENV', 'development'),
  isDev: process.env.NODE_ENV === 'development',
  isProd: process.env.NODE_ENV === 'production',

  // Cloudflare
  cfAccountId: getEnv('CF_ACCOUNT_ID', ''),
  cfApiToken: getEnv('CF_API_TOKEN', ''),

  // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  d1DatabaseId: getEnv('D1_DATABASE_ID', ''),
  kvNamespaceId: getEnv('KV_NAMESPACE_ID', ''),
  r2BucketName: getEnv('R2_BUCKET_NAME', 'automationa-tools-storage'),

  // èªè¨¼
  authSecret: getEnv('AUTH_SECRET', ''),
  jwtSecret: getEnv('JWT_SECRET', ''),
};
EOL
```

### ç’°å¢ƒå¤‰æ•°ã®å‹å®šç¾©

```bash
# ç’°å¢ƒå¤‰æ•°ã®å‹å®šç¾©
mkdir -p src/types
cat > src/types/env.d.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';

// ç’°å¢ƒå¤‰æ•°ã®å‹å®šç¾©
declare namespace NodeJS {
  interface ProcessEnv {
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
    NEXT_PUBLIC_APP_URL: string;
    NEXT_PUBLIC_API_BASE_URL: string;
    NODE_ENV: 'development' | 'production' | 'test';

    // Cloudflare
    CF_ACCOUNT_ID?: string;
    CF_API_TOKEN?: string;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
    D1_DATABASE_ID?: string;
    KV_NAMESPACE_ID?: string;
    R2_BUCKET_NAME?: string;

    // èªè¨¼
    AUTH_SECRET: string;
    JWT_SECRET: string;

    // Cloudflareãƒ©ãƒ³ã‚¿ã‚¤ãƒ å¤‰æ•°ï¼ˆè‡ªå‹•ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
    D1?: D1Database;
    KV_CACHE?: KVNamespace;
    STORAGE?: R2Bucket;
  }
}

// Cloudflare Bindingã®KVNamespaceã¨R2Bucketå‹å®šç¾©
interface KVNamespace {
  get(key: string, options?: { type?: 'text' | 'json' | 'arrayBuffer' | 'stream' }): Promise<string | ArrayBuffer | ReadableStream | unknown | null>;
  put(key: string, value: string | ReadableStream | ArrayBuffer | FormData): Promise<void>;
  delete(key: string): Promise<void>;
  list(options?: { prefix?: string; limit?: number; cursor?: string }): Promise<{ keys: { name: string; expiration?: number }[]; list_complete: boolean; cursor?: string }>;
}

interface R2Bucket {
  get(key: string): Promise<R2Object | null>;
  put(key: string, value: ReadableStream | ArrayBuffer | string): Promise<R2Object>;
  delete(key: string): Promise<void>;
  list(options?: { prefix?: string; delimiter?: string; cursor?: string; limit?: number }): Promise<R2Objects>;
}

interface R2Object {
  key: string;
  version: string;
  size: number;
  etag: string;
  httpEtag: string;
  uploaded: Date;
  httpMetadata?: Record<string, string>;
  customMetadata?: Record<string, string>;
  body: ReadableStream;
  arrayBuffer(): Promise<ArrayBuffer>;
  text(): Promise<string>;
  json<T>(): Promise<T>;
  blob(): Promise<Blob>;
}

interface R2Objects {
  objects: R2Object[];
  truncated: boolean;
  cursor?: string;
  delimitedPrefixes: string[];
}
EOL
```

## 7. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ

ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚

### æ¥ç¶šãƒ†ã‚¹ãƒˆAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ä½œæˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# APIãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ
mkdir -p src/app/api/test

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆAPIä½œæˆ
cat > src/app/api/test/db/route.ts << 'EOL'
import { NextResponse } from 'next/server';
import { UserRepository } from '@/infrastructure/database/repositories/user';
import { D1Database } from '@cloudflare/workers-types';

/**
 * D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 */
export async function GET() {
  try {
    // Cloudflare D1ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const d1 = process.env.D1 as D1Database | undefined;

    if (!d1) {
      return NextResponse.json(
        {
          error: 'D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“',
          hint: 'ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ã€`wrangler pages dev`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„'
        },
        { status: 500 }
      );
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½¿ç”¨ã—ã¦ãƒ†ã‚¹ãƒˆã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
    const userRepo = new UserRepository(d1);
    const users = await userRepo.findAll();

    return NextResponse.json({
      success: true,
      message: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ',
      connectionType: 'D1 Database',
      usersCount: users.length,
      users: users.map(u => ({ id: u.id, name: u.name, email: u.email })),
      timestamp: new Date().toISOString(),
    });
  } catch (error) {
    console.error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      {
        error: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        message: error instanceof Error ? error.message : String(error),
      },
      { status: 500 }
    );
  }
}
EOL
```

### KVæ¥ç¶šãƒ†ã‚¹ãƒˆAPIã®ä½œæˆ

KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# KVæ¥ç¶šãƒ†ã‚¹ãƒˆAPIä½œæˆ
cat > src/app/api/test/kv/route.ts << 'EOL'
import { NextResponse } from 'next/server';

/**
 * KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 */
export async function GET() {
  try {
    // Cloudflare KVãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const kv = process.env.KV_CACHE as KVNamespace | undefined;

    if (!kv) {
      return NextResponse.json(
        {
          error: 'KVã‚¹ãƒˆã‚¢ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“',
          hint: 'ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã¯ã€`wrangler pages dev`ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„'
        },
        { status: 500 }
      );
    }

    // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚­ãƒ¼ã‚’è¨­å®š
    const testKey = 'connection_test';
    const testValue = {
      message: 'Connection successful',
      timestamp: new Date().toISOString(),
    };

    // KVã«å€¤ã‚’æ›¸ãè¾¼ã¿
    await kv.put(testKey, JSON.stringify(testValue));

    // KVã‹ã‚‰å€¤ã‚’èª­ã¿å–ã‚Š
    const retrieved = await kv.get(testKey, 'json');

    return NextResponse.json({
      success: true,
      message: 'KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ',
      connectionType: 'KV Store',
      written: testValue,
      retrieved: retrieved,
    });
  } catch (error) {
    console.error('KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      {
        error: 'KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ',
        message: error instanceof Error ? error.message : String(error),
      },
      { status: 500 }
    );
  }
}
EOL
```

### æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ã®æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ
mkdir -p scripts
cat > scripts/test-connection.js << 'EOL'
const { spawn } = require('child_process');
const fetch = require('node-fetch');
const dotenv = require('dotenv');
const path = require('path');
const chalk = require('chalk');

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
dotenv.config({ path: '.env.local' });

// ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆ
const PORT = 8788;
const BASE_URL = `http://localhost:${PORT}`;

// ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const endpoints = [
  { name: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š', url: `${BASE_URL}/api/test/db` },
  { name: 'KVã‚¹ãƒˆã‚¢æ¥ç¶š', url: `${BASE_URL}/api/test/kv` },
];

// éåŒæœŸé…å»¶é–¢æ•°
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function main() {
  console.log(chalk.blue('ğŸš€ æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...'));

  let wranglerProcess;

  try {
    // wrangler pages dev ã‚’èµ·å‹•ï¼ˆãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦ï¼‰
    console.log(chalk.blue('ğŸ“¡ wrangler pages dev ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...'));

    wranglerProcess = spawn(
      'pnpm', ['wrangler', 'pages', 'dev', '.', '--port', PORT.toString()],
      { stdio: 'pipe', detached: true }
    );

    // æ¨™æº–å‡ºåŠ›ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    wranglerProcess.stdout.on('data', (data) => {
      const output = data.toString();
      if (output.includes('Ready on')) {
        console.log(chalk.green('âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†'));
      }
      // ãƒ‡ãƒãƒƒã‚°å‡ºåŠ›ã¨ã—ã¦è¡¨ç¤º
      process.stdout.write(chalk.dim(`[wrangler] ${output}`));
    });

    // æ¨™æº–ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    wranglerProcess.stderr.on('data', (data) => {
      process.stderr.write(chalk.dim(`[wrangler-err] ${data.toString()}`));
    });

    // ãƒ—ãƒ­ã‚»ã‚¹çµ‚äº†æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const cleanup = () => {
      console.log(chalk.blue('ğŸ§¹ ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™...'));
      try {
        if (wranglerProcess && !wranglerProcess.killed) {
          process.kill(-wranglerProcess.pid);
        }
      } catch (e) {
        console.error(chalk.red('ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:'), e);
      }
    };

    // ã‚·ã‚°ãƒŠãƒ«ãƒãƒ³ãƒ‰ãƒ©ã®è¨­å®š
    process.on('SIGINT', cleanup);
    process.on('SIGTERM', cleanup);

    // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å°‘ã—å¾…ã¤
    console.log(chalk.blue('âŒ› ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™ (15ç§’)...'));
    await delay(15000);

    // å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆ
    for (const endpoint of endpoints) {
      try {
        console.log(chalk.blue(`ğŸ” ${endpoint.name}ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...`));
        const response = await fetch(endpoint.url);
        const data = await response.json();

        if (response.ok) {
          console.log(chalk.green(`âœ… ${endpoint.name}ãƒ†ã‚¹ãƒˆæˆåŠŸ!`));
          console.log(JSON.stringify(data, null, 2));
        } else {
          console.error(chalk.red(`âŒ ${endpoint.name}ãƒ†ã‚¹ãƒˆå¤±æ•—: ${data.error}`));
          console.error(data);
        }
      } catch (error) {
        console.error(chalk.red(`âŒ ${endpoint.name}ãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:`), error);
      }

      console.log(chalk.dim('-----------------------------------'));
    }
  } catch (error) {
    console.error(chalk.red('ğŸ”¥ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«é‡å¤§ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
  } finally {
    // ãƒ—ãƒ­ã‚»ã‚¹ã®çµ‚äº†
    if (wranglerProcess) {
      process.kill(-wranglerProcess.pid);
    }
    console.log(chalk.blue('ğŸ‘‹ ãƒ†ã‚¹ãƒˆå®Œäº†'));
    process.exit(0);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main().catch(console.error);
EOL

# å¿…è¦ãªä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D node-fetch@2.6.7 chalk@4.1.2

# package.jsonã«ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ 
# ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’package.jsonã®scriptséƒ¨åˆ†ã«è¿½åŠ ã™ã‚‹:
# "test:connection": "node scripts/test-connection.js"
```

### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ

```bash
# æ¥ç¶šãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
pnpm test:connection

# å‡ºåŠ›ä¾‹:
# ğŸš€ æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...
# ğŸ“¡ wrangler pages dev ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...
# âŒ› ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™ (15ç§’)...
# âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†
# ğŸ” ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...
# âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ!
# {
#   "success": true,
#   "message": "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ",
#   "connectionType": "D1 Database",
#   "usersCount": 0,
#   "users": [],
#   "timestamp": "2023-12-03T12:34:56.789Z"
# }
# -----------------------------------
# ğŸ” KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...
# âœ… KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ!
# {
#   "success": true,
#   "message": "KVã‚¹ãƒˆã‚¢æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ",
#   "connectionType": "KV Store",
#   "written": {
#     "message": "Connection successful",
#     "timestamp": "2023-12-03T12:34:56.789Z"
#   },
#   "retrieved": {
#     "message": "Connection successful",
#     "timestamp": "2023-12-03T12:34:56.789Z"
#   }
# }
# -----------------------------------
# ğŸ‘‹ ãƒ†ã‚¹ãƒˆå®Œäº†
```

## 8. åˆæœŸãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹ãŸã‚ã®ã‚·ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

### 8.1 ã‚·ãƒ¼ãƒ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ

```bash
# ã‚·ãƒ¼ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä½œæˆ - æ©Ÿèƒ½ã”ã¨ã®ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè£…å¯èƒ½ã«
mkdir -p src/infrastructure/database/seeds/[feature]

# å®Ÿè£…ä¾‹ã¨ã—ã¦ã€useræ©Ÿèƒ½ã¨taskæ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’ä½œæˆ
mkdir -p src/infrastructure/database/seeds/user
mkdir -p src/infrastructure/database/seeds/task
mkdir -p src/infrastructure/database/seeds/common
```

å…±é€šã®ã‚·ãƒ¼ãƒ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã¨ã—ã¦`seed-utils.ts`ã‚’ä½œæˆã—ã¾ã™ï¼š

```bash
# å…±é€šã‚·ãƒ¼ãƒ‰ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ
cat > src/infrastructure/database/seeds/common/seed-utils.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { UserRepository } from '../../repositories/user';
import { TaskRepository } from '../../repositories/task';
import { generateHash } from '@/lib/auth/password';

// ã‚·ãƒ¼ãƒ‰ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
export const seedUsers = [
  {
    email: 'admin@example.com',
    name: 'ç®¡ç†è€…',
    password: 'Admin123!',
    role: 'admin' as const,
  },
  {
    email: 'user@example.com',
    name: 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼',
    password: 'User123!',
    role: 'user' as const,
  },
];

// ã‚·ãƒ¼ãƒ‰ç”¨ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
export const seedTasks = (userId: string) => [
  {
    title: 'åˆæœŸè¨­å®šã®å®Œäº†',
    description: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸè¨­å®šã‚’å®Œäº†ã•ã›ã‚‹',
    status: 'done' as const,
    priority: 3,
    userId,
  },
  {
    title: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…',
    description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹',
    status: 'in_progress' as const,
    priority: 2,
    userId,
  },
  {
    title: 'UIæ”¹å–„',
    description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ”¹å–„ã¨æœ€é©åŒ–',
    status: 'todo' as const,
    priority: 1,
    userId,
  },
];

/**
 * ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æŠ•å…¥ã™ã‚‹é–¢æ•°
 *
 * @param d1 D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
 * @returns å‡¦ç†çµæœ
 */
export async function seedDatabase(d1: D1Database): Promise<{ success: boolean, message: string }> {
  try {
    const userRepo = new UserRepository(d1);
    const taskRepo = new TaskRepository(d1);

    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆäºŒé‡æŠ•å…¥é˜²æ­¢ï¼‰
    const existingAdmin = await userRepo.findByEmail(seedUsers[0].email);

    if (existingAdmin) {
      return {
        success: false,
        message: 'åˆæœŸãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå¿…è¦ãªå ´åˆã¯ã€ã¾ãšãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„ã€‚'
      };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
    const createdUsers = [];
    for (const userData of seedUsers) {
      const hashedPassword = await generateHash(userData.password);
      const user = await userRepo.createUser({
        ...userData,
        password: hashedPassword,
      });
      createdUsers.push(user);
    }

    // ã‚¿ã‚¹ã‚¯ä½œæˆ
    const adminUserId = createdUsers[0].id;
    const adminTasks = seedTasks(adminUserId);

    for (const taskData of adminTasks) {
      await taskRepo.createTask(taskData);
    }

    return {
      success: true,
      message: `ã‚·ãƒ¼ãƒ‰å®Œäº†: ${createdUsers.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨${adminTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚`,
    };
  } catch (error) {
    return {
      success: false,
      message: `ã‚·ãƒ¼ãƒ‰å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : String(error)}`,
    };
  }
}
EOL
```

### 8.2 æ©Ÿèƒ½åˆ¥ã‚·ãƒ¼ãƒ‰ã®å®Ÿè£…ä¾‹

æ©Ÿèƒ½ã”ã¨ã®ã‚·ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ãƒ‰ã®å®Ÿè£…ä¾‹

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ãƒ‰ã®ä½œæˆ
cat > src/infrastructure/database/seeds/user/index.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { UserRepository } from '../../repositories/user';
import { generateHash } from '@/lib/auth/password';

// ã‚·ãƒ¼ãƒ‰ç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿
export const seedUsers = [
  {
    email: 'admin@example.com',
    name: 'ç®¡ç†è€…',
    password: 'Admin123!',
    role: 'admin' as const,
  },
  {
    email: 'user@example.com',
    name: 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼',
    password: 'User123!',
    role: 'user' as const,
  },
];

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
 */
export async function seedUsers(d1: D1Database): Promise<{ success: boolean, users: any[], message: string }> {
  try {
    const userRepo = new UserRepository(d1);

    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆäºŒé‡æŠ•å…¥é˜²æ­¢ï¼‰
    const existingAdmin = await userRepo.findByEmail(seedUsers[0].email);

    if (existingAdmin) {
      return {
        success: false,
        users: [],
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™'
      };
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼‰
    const createdUsers = [];
    for (const userData of seedUsers) {
      const hashedPassword = await generateHash(userData.password);
      const user = await userRepo.createUser({
        ...userData,
        password: hashedPassword,
      });
      createdUsers.push(user);
    }

    return {
      success: true,
      users: createdUsers,
      message: `${createdUsers.length}äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ`
    };
  } catch (error) {
    return {
      success: false,
      users: [],
      message: `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚·ãƒ¼ãƒ‰å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : String(error)}`
    };
  }
}
EOL
```

#### ã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒ‰ã®å®Ÿè£…ä¾‹

```bash
# ã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒ‰ã®ä½œæˆ
cat > src/infrastructure/database/seeds/task/index.ts << 'EOL'
import { D1Database } from '@cloudflare/workers-types';
import { TaskRepository } from '../../repositories/task';

// ã‚·ãƒ¼ãƒ‰ç”¨ã®ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿
export const seedTasks = (userId: string) => [
  {
    title: 'åˆæœŸè¨­å®šã®å®Œäº†',
    description: 'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸè¨­å®šã‚’å®Œäº†ã•ã›ã‚‹',
    status: 'done' as const,
    priority: 3,
    userId,
  },
  {
    title: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†æ©Ÿèƒ½ã®å®Ÿè£…',
    description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™»éŒ²ãƒ»ç·¨é›†ãƒ»å‰Šé™¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹',
    status: 'in_progress' as const,
    priority: 2,
    userId,
  },
  {
    title: 'UIæ”¹å–„',
    description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®æ”¹å–„ã¨æœ€é©åŒ–',
    status: 'todo' as const,
    priority: 1,
    userId,
  },
];

/**
 * ã‚¿ã‚¹ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
 */
export async function seedTasksForUser(d1: D1Database, userId: string): Promise<{ success: boolean, tasks: any[], message: string }> {
  try {
    const taskRepo = new TaskRepository(d1);
    const tasksToCreate = seedTasks(userId);

    const createdTasks = [];
    for (const taskData of tasksToCreate) {
      const task = await taskRepo.createTask(taskData);
      createdTasks.push(task);
    }

    return {
      success: true,
      tasks: createdTasks,
      message: `${createdTasks.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸ`
    };
  } catch (error) {
    return {
      success: false,
      tasks: [],
      message: `ã‚¿ã‚¹ã‚¯ã‚·ãƒ¼ãƒ‰å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error instanceof Error ? error.message : String(error)}`
    };
  }
}
EOL
```

### 8.3 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ

```bash
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ä½œæˆ
mkdir -p src/lib/auth
touch src/lib/auth/password.ts
```

`password.ts`ã«ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ï¼š

```typescript
import { pbkdf2Sync, randomBytes } from 'crypto';

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã™ã‚‹é–¢æ•°
 *
 * @param password å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
 * @returns ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆsalt:hashå½¢å¼ï¼‰
 */
export async function generateHash(password: string): Promise<string> {
  const salt = randomBytes(16).toString('hex');
  const hash = pbkdf2Sync(password, salt, 1000, 64, 'sha512').toString('hex');
  return `${salt}:${hash}`;
}

/**
 * ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã‚’æ¤œè¨¼ã™ã‚‹é–¢æ•°
 *
 * @param storedHash ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒãƒƒã‚·ãƒ¥
 * @param password æ¤œè¨¼ã™ã‚‹å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
 * @returns æ¤œè¨¼çµæœï¼ˆä¸€è‡´ã™ã‚‹å ´åˆtrueï¼‰
 */
export async function verifyHash(storedHash: string, password: string): Promise<boolean> {
  const [salt, hash] = storedHash.split(':');
  const calculatedHash = pbkdf2Sync(password, salt, 1000, 64, 'sha512').toString('hex');
  return hash === calculatedHash;
}
```

### 8.4 ã‚·ãƒ¼ãƒ‰å®Ÿè¡ŒAPIã®ä½œæˆ

APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã‚·ãƒ¼ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™ï¼š

```bash
# ã‚·ãƒ¼ãƒ‰å®Ÿè¡ŒAPIä½œæˆç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
mkdir -p src/app/api/admin/seed
touch src/app/api/admin/seed/route.ts
```

`route.ts`ã«ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¾ã™ï¼š

```typescript
import { NextResponse } from 'next/server';
import { seedDatabase } from '@/infrastructure/database/seeds/seed-utils';
import { D1Database } from '@cloudflare/workers-types';

/**
 * ç®¡ç†è€…å‘ã‘ã®ã‚·ãƒ¼ãƒ‰APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 * æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿè¡Œã§ããªã„å®‰å…¨å¯¾ç­–ã‚ã‚Š
 */
export async function POST(req: Request) {
  try {
    // æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿè¡Œä¸å¯ï¼ˆå®‰å…¨å¯¾ç­–ï¼‰
    if (process.env.NODE_ENV === 'production') {
      return NextResponse.json(
        {
          error: 'æœ¬ç•ªç’°å¢ƒã§ã¯ã“ã®æ“ä½œã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚é–‹ç™º/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚',
        },
        { status: 403 }
      );
    }

    // D1ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const d1 = process.env.D1 as D1Database | undefined;
    if (!d1) {
      return NextResponse.json(
        { error: 'D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`wrangler pages dev`ã§èµ·å‹•ã—ã¦ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    }

    // ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œ
    const result = await seedDatabase(d1);

    if (result.success) {
      return NextResponse.json({ message: result.message });
    } else {
      return NextResponse.json({ warning: result.message }, { status: 400 });
    }
  } catch (error) {
    console.error('ã‚·ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      {
        error: 'ã‚·ãƒ¼ãƒ‰å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ',
        message: error instanceof Error ? error.message : String(error),
      },
      { status: 500 }
    );
  }
}
```

### 8.5 package.jsonã¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ 

`package.json`ã«ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ï¼š

```json
"scripts": {
  // ... æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  "db:generate": "drizzle-kit generate",
  "db:migrate": "node scripts/migrate.js",
  "db:studio": "drizzle-kit studio",
  "db:seed": "node scripts/seed-db.js"
}
```

### 8.6 å¿…è¦ãªä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D node-fetch@2.6.7 chalk@4.1.2
```

### 8.7 ã‚·ãƒ¼ãƒ‰ã®å®Ÿè¡Œ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```bash
pnpm db:seed
```

æˆåŠŸã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
ğŸŒ± ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...
ğŸ“¡ wrangler pages dev ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...
âŒ› ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™ (15ç§’)...
âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†
ğŸ” ã‚·ãƒ¼ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™...
âœ… ã‚·ãƒ¼ãƒ‰æˆåŠŸ!
ã‚·ãƒ¼ãƒ‰å®Œäº†: 2äººã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨3ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚
ğŸ‘‹ å‡¦ç†å®Œäº†
```

### 8.5 ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä½œæˆ

ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã‚·ãƒ¼ãƒ‰å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚æ©Ÿèƒ½ã”ã¨ã®ã‚·ãƒ¼ãƒ‰ã‚’å€‹åˆ¥ã«å®Ÿè¡Œã—ãŸã‚Šã€å…¨æ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’ä¸€æ‹¬å®Ÿè¡Œã—ãŸã‚Šã§ãã‚‹ã‚ˆã†ã«è¨­è¨ˆã—ã¾ã™ã€‚

```bash
# ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
mkdir -p scripts
cat > scripts/seed-db.js << 'EOL'
const fetch = require('node-fetch');
const { spawn } = require('child_process');
const dotenv = require('dotenv');
const chalk = require('chalk');
const path = require('path');
const fs = require('fs');

// ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
dotenv.config({ path: '.env.local' });

// ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®ãƒãƒ¼ãƒˆ
const PORT = 8789;
const SEED_ENDPOINT = `http://localhost:${PORT}/api/admin/seed`;

// åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’æ¤œå‡º
const SEEDS_DIR = path.resolve(__dirname, '../src/infrastructure/database/seeds');
const availableFeatures = fs.readdirSync(SEEDS_DIR)
  .filter(dir => {
    // commonä»¥å¤–ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã¤ã€index.tsãŒã‚ã‚‹ã‚‚ã®ã‚’æ¤œå‡º
    const isDirectory = fs.statSync(path.join(SEEDS_DIR, dir)).isDirectory();
    const hasIndexFile = fs.existsSync(path.join(SEEDS_DIR, dir, 'index.ts'));
    return isDirectory && hasIndexFile && dir !== 'common';
  });

// ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å¼•æ•°ã‚’è§£æ
const args = process.argv.slice(2);
const requestedFeatures = args.length > 0 ? args : ['all'];

// éåŒæœŸé…å»¶é–¢æ•°
const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// ãƒ¡ã‚¤ãƒ³å‡¦ç†
async function main() {
  console.log(chalk.blue('ğŸŒ± ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚·ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã™...'));

  if (requestedFeatures.includes('all')) {
    console.log(chalk.blue(`ã™ã¹ã¦ã®æ©Ÿèƒ½(${availableFeatures.join(', ')})ã®ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™`));
  } else {
    // æœ‰åŠ¹ãªãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã‹ãƒã‚§ãƒƒã‚¯
    const invalidFeatures = requestedFeatures.filter(f => !availableFeatures.includes(f));
    if (invalidFeatures.length > 0) {
      console.error(chalk.red(`ã‚¨ãƒ©ãƒ¼: æ¬¡ã®æ©Ÿèƒ½ã¯æœ‰åŠ¹ã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${invalidFeatures.join(', ')}`));
      console.log(chalk.yellow(`æœ‰åŠ¹ãªæ©Ÿèƒ½ã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™: ${availableFeatures.join(', ')}`));
      process.exit(1);
    }
    console.log(chalk.blue(`æŒ‡å®šã•ã‚ŒãŸæ©Ÿèƒ½(${requestedFeatures.join(', ')})ã®ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™`));
  }

  let wranglerProcess;

  try {
    // wrangler pages dev ã‚’èµ·å‹•
    console.log(chalk.blue('ğŸ“¡ wrangler pages dev ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™...'));

    wranglerProcess = spawn(
      'pnpm', ['wrangler', 'pages', 'dev', '.', '--port', PORT.toString()],
      { stdio: 'pipe', detached: true }
    );

    // ãƒ—ãƒ­ã‚»ã‚¹å‡ºåŠ›ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    wranglerProcess.stdout.on('data', (data) => {
      const output = data.toString();
      if (output.includes('Ready on')) {
        console.log(chalk.green('âœ… ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å®Œäº†'));
      }
      // è©³ç´°å‡ºåŠ›
      process.stdout.write(chalk.dim(`[wrangler] ${output}`));
    });

    // ã‚¨ãƒ©ãƒ¼å‡ºåŠ›ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    wranglerProcess.stderr.on('data', (data) => {
      process.stderr.write(chalk.dim(`[wrangler-err] ${data.toString()}`));
    });

    // ã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚’å¾…ã¤
    console.log(chalk.blue('âŒ› ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã¾ã™ (15ç§’)...'));
    await delay(15000);

    // ã‚·ãƒ¼ãƒ‰APIã‚’å‘¼ã³å‡ºã—
    console.log(chalk.blue('ğŸ” ã‚·ãƒ¼ãƒ‰APIã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™...'));

    const features = requestedFeatures.includes('all') ? availableFeatures : requestedFeatures;

    const response = await fetch(SEED_ENDPOINT, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ features }),
    });

    const data = await response.json();

    if (response.ok) {
      console.log(chalk.green('âœ… ã‚·ãƒ¼ãƒ‰æˆåŠŸ!'));
      console.log(chalk.green(data.message));

      // å„æ©Ÿèƒ½ã®è©³ç´°çµæœã‚’è¡¨ç¤º
      if (data.results) {
        Object.entries(data.results).forEach(([feature, result]) => {
          console.log(chalk.cyan(`- ${feature}: ${result.message}`));
        });
      }
    } else {
      if (response.status === 400 && data.warning) {
        console.warn(chalk.yellow('âš ï¸ è­¦å‘Š:'), data.warning);
      } else {
        console.error(chalk.red('âŒ ã‚·ãƒ¼ãƒ‰å¤±æ•—:'), data.error || 'unknown error');
      }
    }
  } catch (error) {
    console.error(chalk.red('ğŸ”¥ ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:'), error);
  } finally {
    // ãƒ—ãƒ­ã‚»ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if (wranglerProcess) {
      try {
        process.kill(-wranglerProcess.pid);
      } catch (e) {
        // ãƒ—ãƒ­ã‚»ã‚¹ãŒæ—¢ã«çµ‚äº†ã—ã¦ã„ã‚‹å ´åˆã¯ç„¡è¦–
      }
    }
    console.log(chalk.blue('ğŸ‘‹ å‡¦ç†å®Œäº†'));
    process.exit(0);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main().catch(console.error);
EOL
```

ã“ã‚Œã«ã‚ˆã‚Šã€æ¬¡ã®ã‚ˆã†ã«ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã§ãã¾ã™ï¼š

```bash
# ã™ã¹ã¦ã®æ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
pnpm db:seed

# ç‰¹å®šã®æ©Ÿèƒ½ã®ã¿ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
pnpm db:seed user
pnpm db:seed task

# è¤‡æ•°ã®æ©Ÿèƒ½ã‚’æŒ‡å®šã—ã¦ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
pnpm db:seed user task
```

### 8.6 ã‚·ãƒ¼ãƒ‰APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®æ‹¡å¼µ

æ©Ÿèƒ½ã”ã¨ã®ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã€APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æ‹¡å¼µã—ã¾ã™ã€‚

```bash
# ã‚·ãƒ¼ãƒ‰å®Ÿè¡ŒAPIã‚’æ›´æ–°
cat > src/app/api/admin/seed/route.ts << 'EOL'
import { NextResponse } from 'next/server';
import { seedDatabase } from '@/infrastructure/database/seeds/common/seed-utils';
import { D1Database } from '@cloudflare/workers-types';
import * as fs from 'fs';
import * as path from 'path';

/**
 * ç®¡ç†è€…å‘ã‘ã®ã‚·ãƒ¼ãƒ‰APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
 * æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿè¡Œã§ããªã„å®‰å…¨å¯¾ç­–ã‚ã‚Š
 */
export async function POST(req: Request) {
  try {
    // æœ¬ç•ªç’°å¢ƒã§ã¯å®Ÿè¡Œä¸å¯ï¼ˆå®‰å…¨å¯¾ç­–ï¼‰
    if (process.env.NODE_ENV === 'production') {
      return NextResponse.json(
        { error: 'æœ¬ç•ªç’°å¢ƒã§ã¯ã“ã®æ“ä½œã¯å®Ÿè¡Œã§ãã¾ã›ã‚“ã€‚é–‹ç™º/ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ã€‚' },
        { status: 403 }
      );
    }

    // D1ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const d1 = process.env.D1 as D1Database | undefined;
    if (!d1) {
      return NextResponse.json(
        { error: 'D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`wrangler pages dev`ã§èµ·å‹•ã—ã¦ãã ã•ã„ã€‚' },
        { status: 500 }
      );
    }

    // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‚’è§£æ
    const body = await req.json().catch(() => ({}));
    const requestedFeatures = Array.isArray(body.features) ? body.features : [];

    // åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’ç¢ºèª
    const seedsDir = path.resolve(process.cwd(), 'src/infrastructure/database/seeds');
    const availableFeatures = fs.readdirSync(seedsDir)
      .filter(dir => {
        try {
          const stat = fs.statSync(path.join(seedsDir, dir));
          const hasIndexFile = fs.existsSync(path.join(seedsDir, dir, 'index.ts'));
          return stat.isDirectory() && hasIndexFile && dir !== 'common';
        } catch (e) {
          return false;
        }
      });

    // ç‰¹å®šã®æ©Ÿèƒ½ãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã‚„'all'ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ã™ã¹ã¦ã®æ©Ÿèƒ½ã‚’å¯¾è±¡ã«ã™ã‚‹
    const featuresToSeed = requestedFeatures.length > 0 ?
      requestedFeatures.filter(f => availableFeatures.includes(f)) :
      availableFeatures;

    if (featuresToSeed.length === 0) {
      // å…±é€šã‚·ãƒ¼ãƒ‰ã«æˆ»ã‚‹
      const result = await seedDatabase(d1);
      return result.success ?
        NextResponse.json({ message: result.message }) :
        NextResponse.json({ warning: result.message }, { status: 400 });
    }

    // å„æ©Ÿèƒ½ã®ã‚·ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
    const results: Record<string, any> = {};
    let successCount = 0;

    for (const feature of featuresToSeed) {
      try {
        // å‹•çš„ã«ã‚·ãƒ¼ãƒ‰ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        const seedModule = require(`@/infrastructure/database/seeds/${feature}`);
        const seedFunction = seedModule.default || Object.values(seedModule)[0];

        if (typeof seedFunction === 'function') {
          // ã‚·ãƒ¼ãƒ‰é–¢æ•°ã‚’å®Ÿè¡Œ
          const result = await seedFunction(d1);
          results[feature] = result;

          if (result.success) {
            successCount++;
          }
        } else {
          results[feature] = {
            success: false,
            message: `ã‚·ãƒ¼ãƒ‰é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${feature})`
          };
        }
      } catch (error) {
        results[feature] = {
          success: false,
          message: `ã‚·ãƒ¼ãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error instanceof Error ? error.message : String(error)}`
        };
      }
    }

    // çµæœã®é›†è¨ˆ
    const allSuccess = successCount === featuresToSeed.length;
    const message = allSuccess ?
      `ã™ã¹ã¦ã®ã‚·ãƒ¼ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ (${successCount}/${featuresToSeed.length})` :
      `ä¸€éƒ¨ã®ã‚·ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ã¾ã—ãŸ (æˆåŠŸ: ${successCount}/${featuresToSeed.length})`;

    return NextResponse.json({
      success: allSuccess,
      message,
      results,
      features: featuresToSeed,
    }, { status: allSuccess ? 200 : 207 });

  } catch (error) {
    console.error('ã‚·ãƒ¼ãƒ‰å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    return NextResponse.json(
      { error: 'ã‚·ãƒ¼ãƒ‰å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ', message: error instanceof Error ? error.message : String(error) },
      { status: 500 }
    );
  }
}
EOL
```

### 8.7 å¿…è¦ãªä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
# å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pnpm add -D node-fetch@2.6.7 chalk@4.1.2
```

### 8.8 package.jsonã¸ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆè¿½åŠ 

`package.json`ã«ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ï¼š

```json
"scripts": {
  // ... æ—¢å­˜ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
  "db:generate": "drizzle-kit generate",
  "db:migrate": "node scripts/migrate.js",
```

4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¦å†è©¦è¡Œï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

   ```bash
   # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã‚‹ã®ã§æ³¨æ„ï¼‰
   # ã“ã‚Œã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿è¡Œã†ã“ã¨
   wrangler d1 execute automationa-tools-db --command "DROP TABLE IF EXISTS users; DROP TABLE IF EXISTS tasks;"

   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œ
   pnpm db:migrate
   ```

### 10.4 ãƒ‡ãƒ—ãƒ­ã‚¤ã®å•é¡Œ

**ç—‡çŠ¶**: Cloudflare Pagesã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**è§£æ±ºç­–**:

1. APIãƒˆãƒ¼ã‚¯ãƒ³ã®æ¨©é™ã‚’ç¢ºèª

   - Cloudflareãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã€ä½¿ç”¨ã—ã¦ã„ã‚‹APIãƒˆãƒ¼ã‚¯ãƒ³ãŒCF_API_TOKENã«æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   - ãƒˆãƒ¼ã‚¯ãƒ³ã«Pagesã€D1ã€KVã€R2ã®ç·¨é›†æ¨©é™ãŒã‚ã‚‹ã‹ç¢ºèª

2. ç’°å¢ƒå¤‰æ•°ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

   ```bash
   # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã•ã‚Œãªã„ãŒåå‰ã¯ç¢ºèªå¯èƒ½ï¼‰
   env | grep CF_
   env | grep D1_
   env | grep KV_
   ```

3. wranglerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª

   ```bash
   wrangler --version
   # æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ãªã„å ´åˆã¯æ›´æ–°
   pnpm add -g wrangler@latest
   ```

4. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‹ç¢ºèª

   ```bash
   # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
   pnpm build
   ```

5. æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è©¦ã™
   ```bash
   # æ‰‹å‹•ã§ãƒ‡ãƒ—ãƒ­ã‚¤
   pnpm wrangler pages deploy ./out --project-name=automationa-tools-application
   ```

### 10.5 ä¸€èˆ¬çš„ãªãƒ‡ãƒãƒƒã‚°æ‰‹æ³•

1. **ãƒ­ã‚°ã‚’è©³ç´°ã«å‡ºåŠ›**:

   ```js
   // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‚³ãƒ¼ãƒ‰ã§ã®ãƒ‡ãƒãƒƒã‚°
   console.log('ãƒ‡ãƒãƒƒã‚°æƒ…å ±:', {
     variable1,
     variable2,
     objectDetails: JSON.stringify(someObject, null, 2),
   });
   ```

2. **Cloudflareãƒ­ã‚°ã®ç¢ºèª**:

   ```bash
   # Cloudflareãƒ¯ãƒ¼ã‚«ãƒ¼ã®ãƒ­ã‚°ã‚’è¡¨ç¤º
   wrangler tail
   ```

3. **ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª**:

   ```bash
   # Cloudflareä¸Šã®ç’°å¢ƒå¤‰æ•°ã‚’è¡¨ç¤º
   wrangler pages env list
   ```

4. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çŠ¶æ…‹ã®ç¢ºèª**:

   ```bash
   # ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
   wrangler d1 execute automationa-tools-db --command "SELECT name FROM sqlite_master WHERE type='table'"

   # ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’ç¢ºèª
   wrangler d1 execute automationa-tools-db --command "SELECT COUNT(*) FROM users"
   ```

5. **Drizzle Studio ã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œ**:
   ```bash
   # Drizzle Studio ã‚’èµ·å‹•
   pnpm db:studio
   # ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’è¦–è¦šçš„ã«æ“ä½œå¯èƒ½
   ```

### 10.3 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å•é¡Œ

**ç—‡çŠ¶**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹

**è§£æ±ºç­–**:

1. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ–‡æ³•ã‚¨ãƒ©ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯

   ```bash
   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ç¢ºèª
   cat drizzle/*.sql
   # SQLã®æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ç¢ºèª
   ```

2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ¸…æƒã—ã¦å†ç”Ÿæˆ

   ```bash
   # å¤ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
   rm -rf drizzle

   # ã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰å†ç”Ÿæˆ
   pnpm drizzle-kit generate
   ```

3. D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè¨­å®šã‚’ç¢ºèª

   ```bash
   # D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   grep "database_id" wrangler.toml

   # D1ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°åãŒæ­£ã—ã„ã‹ç¢ºèª
   grep "binding" wrangler.toml | grep -A 1 "d1_databases"
   ```

4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ã—ã¦å†è©¦è¡Œï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰

   ```bash
   # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã‚‹ã®ã§æ³¨æ„ï¼‰
   # ã“ã‚Œã¯é–‹ç™ºç’°å¢ƒã§ã®ã¿è¡Œã†ã“ã¨
   wrangler d1 execute automationa-tools-db --command "DROP TABLE IF EXISTS users; DROP TABLE IF EXISTS tasks;"

   # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†å®Ÿè¡Œ
   pnpm db:migrate
   ```

## ã¾ã¨ã‚

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è©³ç´°ã«èª¬æ˜ã—ã¾ã—ãŸï¼š

1. Cloudflare D1ï¼ˆSQLiteäº’æ›ï¼‰ã€KVã€R2ã®åŠ¹ç‡çš„ãªè¨­å®šæ–¹æ³•
2. Drizzle ORMã‚’æ´»ç”¨ã—ãŸå‹å®‰å…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒªãƒ³ã‚°
3. ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®æŠ½è±¡åŒ–
4. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®ä¸€è²«ã—ãŸæ§‹æˆ
5. CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«ã‚ˆã‚‹å®‰å…¨ã§å†ç¾æ€§ã®é«˜ã„ãƒ‡ãƒ—ãƒ­ã‚¤
6. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ç®¡ç†æ‰‹æ³•
7. ä¸€èˆ¬çš„ãªå•é¡Œã«å¯¾ã™ã‚‹ä½“ç³»çš„ãªãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ‰‹é †ã«å¾“ã†ã“ã¨ã§ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¯ä¸€è²«ã—ãŸæ–¹æ³•ã§Cloudflare D1ã€KVã€R2ã‚’ä½¿ç”¨ã—ãŸã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚ã¾ãŸã€ã“ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯å°†æ¥çš„ãªãƒªã‚½ãƒ¼ã‚¹æ‹¡å¼µã‚„ä»–ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®ç§»è¡Œã‚‚å®¹æ˜“ã«ãªã‚‹ã‚ˆã†è¨­è¨ˆã•ã‚Œã¦ã„ã¾ã™ã€‚

æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ã€[å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ«ãƒ¼ãƒ«](./overall_rule.md)ã«åŸºã¥ãæ©Ÿèƒ½é–‹ç™ºã‚„ã€[åˆæœŸè¨­å®šã‚¬ã‚¤ãƒ‰](./initial_setup_guide.md)ã§èª¬æ˜ã•ã‚Œã¦ã„ã‚‹ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é€£æºã«é€²ã‚€ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
