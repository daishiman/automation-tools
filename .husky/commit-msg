#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å½¢å¼ã‚’æ¤œè¨¼
commit_msg_file=$1
commit_msg=$(cat $commit_msg_file)

# package.jsonã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é–¢é€£ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
has_commitlint=false
has_custom_script=false

if grep -q "\"@commitlint/cli\"" package.json || grep -q "\"commitlint\"" package.json; then
  has_commitlint=true
fi

if grep -q "\"create-commit-msg\"" package.json; then
  has_custom_script=true
fi

# ä½¿ç”¨å¯èƒ½ãªãƒ„ãƒ¼ãƒ«ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
if [ "$has_commitlint" = true ]; then
  echo "ğŸ” commitlintã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ä¸­..."
  pnpm commitlint --edit $commit_msg_file
  result=$?
  if [ $result -ne 0 ]; then
    exit 1
  fi
elif [ "$has_custom_script" = true ]; then
  echo "ğŸ” ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ä¸­..."
  pnpm create-commit-msg $commit_msg_file
  result=$?
  if [ $result -ne 0 ]; then
    exit 1
  fi
else
  # æ¨™æº–ã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯
  echo "ğŸ” ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œè¨¼ä¸­..."

  # 1. ã‚³ãƒŸãƒƒãƒˆã‚¿ã‚¤ãƒ—ã®æ¤œè¨¼
  # ä¾‹: feat: æ–°æ©Ÿèƒ½è¿½åŠ , fix: ãƒã‚°ä¿®æ­£, etc.
  if ! echo "$commit_msg" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert)(\(.+\))?:"; then
    echo "âŒ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€‚"
    echo "ä»¥ä¸‹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„:"
    echo "feat: æ–°æ©Ÿèƒ½"
    echo "fix: ãƒã‚°ä¿®æ­£"
    echo "docs: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ã®å¤‰æ›´"
    echo "style: ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã«å½±éŸ¿ã—ãªã„å¤‰æ›´ï¼ˆã‚¹ãƒšãƒ¼ã‚¹ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€ã‚»ãƒŸã‚³ãƒ­ãƒ³ãªã©ï¼‰"
    echo "refactor: ãƒã‚°ä¿®æ­£ã‚„æ©Ÿèƒ½è¿½åŠ ã§ã¯ãªã„ã‚³ãƒ¼ãƒ‰å¤‰æ›´"
    echo "perf: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´"
    echo "test: ãƒ†ã‚¹ãƒˆã®è¿½åŠ ãƒ»ä¿®æ­£"
    echo "chore: ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ„ãƒ¼ãƒ«ã®å¤‰æ›´"
    echo "build: ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã‚„å¤–éƒ¨ä¾å­˜é–¢ä¿‚ã«é–¢ã™ã‚‹å¤‰æ›´"
    echo "ci: CIè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å¤‰æ›´"
    echo "revert: ä»¥å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–ã‚Šæ¶ˆã™"
    echo ""
    echo "ä¾‹: feat: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ©Ÿèƒ½ã®è¿½åŠ "
    exit 1
  fi

  # 2. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é•·ã•ã‚’ãƒã‚§ãƒƒã‚¯
  if [ ${#commit_msg} -lt 10 ]; then
    echo "âŒ ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒçŸ­ã™ãã¾ã™ã€‚å…·ä½“çš„ã«å¤‰æ›´å†…å®¹ã‚’èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
    exit 1
  fi

  # 3. æœ¬æ–‡ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  if [ $(echo "$commit_msg" | wc -l) -lt 2 ] && [ ${#commit_msg} -lt 50 ]; then
    echo "âš ï¸ æ¨å¥¨: è¤‡é›‘ãªå¤‰æ›´ã«ã¯è©³ç´°ãªèª¬æ˜ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚"
  fi

  # 4. çµµæ–‡å­—ã®ã‚µãƒãƒ¼ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  emoji_pattern=':([a-z_]+):'
  if [[ "$commit_msg" =~ $emoji_pattern ]]; then
    echo "â„¹ï¸ çµµæ–‡å­—ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${BASH_REMATCH[1]}"
  fi

  # 5. ãƒã‚±ãƒƒãƒˆç•ªå·ã®å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  ticket_pattern='#([0-9]+)'
  if [[ "$commit_msg" =~ $ticket_pattern ]]; then
    echo "â„¹ï¸ ãƒã‚±ãƒƒãƒˆç•ªå·ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: #${BASH_REMATCH[1]}"
  elif grep -q "issue" package.json && ! echo "$commit_msg" | grep -qE "#[0-9]+"; then
    echo "âš ï¸ æ¨å¥¨: ãƒã‚±ãƒƒãƒˆç•ªå·ã‚’å«ã‚ã‚‹ã¨å¤‰æ›´ã®è¿½è·¡ãŒå®¹æ˜“ã«ãªã‚Šã¾ã™ (ä¾‹: #123)"
  fi
fi

echo "âœ… ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å½¢å¼ãŒæ­£ã—ã„ã§ã™ã€‚"