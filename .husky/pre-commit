#!/bin/sh
# ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«ç®¡ç†

echo "ğŸ” ã‚³ãƒŸãƒƒãƒˆå‰ã®ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)" || exit 1

# é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
start_time=$(date +%s)

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚Œã¦ã„ãªã„å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
staged_files=$(git diff --cached --name-only --diff-filter=ACM)
unstaged_files=$(git diff --name-only)

# ã™ã¹ã¦ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
all_changed_files="$staged_files $unstaged_files"
js_ts_files=$(echo "$all_changed_files" | grep -E '\.tsx?$|\.jsx?$' | grep -v '^scripts/' | sort -u || true)
css_json_md_files=$(echo "$all_changed_files" | grep -E '\.(json|md|mdx|css)$' | sort -u || true)
rules_files=$(echo "$all_changed_files" | grep -E '^rules/.+\.md$' | sort -u || true)

# å¤‰æ›´ãŒãªã„å ´åˆã¯æ—©æœŸçµ‚äº†
if [ -z "$all_changed_files" ]; then
  echo "ğŸ“ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã€‚ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  exit 0
fi

# ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—ãƒ•ãƒ©ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
skip_tests=${SKIP_TESTS:-""}

# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ã©ã†ã‹ã‚’è¿½è·¡
has_errors=0

# 1. JS/TSãƒ•ã‚¡ã‚¤ãƒ«ã®lintã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
if [ ! -z "$js_ts_files" ]; then
  echo "ğŸ§¹ ESLint/Prettierå®Ÿè¡Œä¸­..."
  # ESLintå®Ÿè¡Œ
  pnpm eslint --fix $js_ts_files
  lint_result=$?

  if [ $lint_result -ne 0 ]; then
    echo "âŒ ESLintã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
    has_errors=1
  fi

  # Prettierå®Ÿè¡Œ
  pnpm prettier --write $js_ts_files
  prettier_result=$?

  if [ $prettier_result -ne 0 ]; then
    echo "âŒ Prettierã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    has_errors=1
  fi
fi

# 2. CSS/JSON/MD/MDXãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
if [ ! -z "$css_json_md_files" ]; then
  echo "CSS/JSON/Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¸­..."
  pnpm prettier --write $css_json_md_files
  css_json_md_result=$?

  if [ $css_json_md_result -ne 0 ]; then
    echo "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    has_errors=1
  fi
fi

# 3. å‹ãƒã‚§ãƒƒã‚¯ï¼ˆJSãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰
if [ $has_errors -eq 0 ] && echo "$js_ts_files" | grep -q "\.tsx\?$"; then
  echo "ğŸ“˜ å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
  pnpm type-check
  type_check_result=$?

  if [ $type_check_result -ne 0 ]; then
    echo "âŒ å‹ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
    has_errors=1
  fi
else
  echo "ğŸ“ TSãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—ã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯çµæœ
echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã™ã‚‹
pnpm audit --production --audit-level=critical || true
echo "â„¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å°†æ¥çš„ã«å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"

# 5. JS/TSãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã€é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
if [ $has_errors -eq 0 ] && [ ! -z "$js_ts_files" ] && [ -z "$skip_tests" ]; then
  echo "ğŸ§ª å¤‰æ›´é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."

  # é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆåŠ¹ç‡çš„ãªæ–¹æ³•ï¼‰
  NODE_OPTIONS="--max-old-space-size=4096" pnpm vitest related --run $js_ts_files --passWithNoTests
  test_result=$?

  if [ $test_result -ne 0 ]; then
    echo "âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
    has_errors=1
  else
    echo "âœ… ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸã€‚"
  fi
else
  echo "ğŸ“ ãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã‚’å¿…ãšå®Ÿè¡Œã™ã‚‹ã«ã¯ SKIP_TESTS=0 ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
  test_result=0
fi

# 6. rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿åŸºæœ¬æ¤œè¨¼
if [ $has_errors -eq 0 ] && [ ! -z "$rules_files" ]; then
  echo "ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼ä¸­..."
  rules_errors=0

  for file in $rules_files; do
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼
    echo "  - $file ã®åŸºæœ¬æ¤œè¨¼ä¸­..."

    # 1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
    if [ ! -s "$file" ]; then
      echo "    âŒ $file ãŒç©ºã§ã™"
      rules_errors=1
      continue
    fi

    # 2. æœ€ä½é™ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
    if ! grep -q "^# " "$file"; then
      echo "    âš ï¸ $file ã«é©åˆ‡ãªè¦‹å‡ºã—(#)ãŒã‚ã‚Šã¾ã›ã‚“"
      rules_errors=1
    fi
  done

  if [ $rules_errors -ne 0 ]; then
    echo "âŒ rulesãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
    has_errors=1
  else
    echo "âœ… rulesãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
  fi
else
  echo "ğŸ“ ruleså¤‰æ›´ãªã—ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
fi

# ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã§ä¿®æ­£ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã™ã‚‹
if [ -n "$(git diff --name-only)" ]; then
  echo "ğŸ“ ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼ã«ã‚ˆã‚‹å¤‰æ›´ã®ã¿ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã™..."
  # ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°æ¸ˆã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã†ã¡ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒã‚¿ãƒ¼å®Ÿè¡Œå¾Œã«å¤‰æ›´ã•ã‚ŒãŸã‚‚ã®ã®ã¿ã‚’å†ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°
  for file in $staged_files; do
    if [ -n "$(git diff --name-only $file)" ]; then
      echo "  - $file ã®å¤‰æ›´ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã—ã¾ã™"
      git add $file
    fi
  done
fi

# å®Ÿè¡Œçµ‚äº†æ™‚é–“ã¨çµæœè¡¨ç¤º
end_time=$(date +%s)
execution_time=$((end_time - start_time))

# æˆåŠŸãƒ»å¤±æ•—ã®è¡¨ç¤ºã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã®è¨­å®š
if [ $has_errors -eq 1 ]; then
  echo "âŒ ãƒã‚§ãƒƒã‚¯ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
  echo "â±ï¸ å®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"
  exit 1
else
  echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  echo "â±ï¸ å®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"
  echo "â„¹ï¸ â€»ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹å ´åˆ: SKIP_TESTS=1 git commit -m \"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸\""
  exit 0
fi
