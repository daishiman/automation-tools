#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” ã‚³ãƒŸãƒƒãƒˆå‰ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
all_changed_files=$(git diff --cached --name-only --diff-filter=ACM)
js_ts_files=$(echo "$all_changed_files" | grep -E '\.tsx?$|\.jsx?$')
rules_files=$(echo "$all_changed_files" | grep -E '^rules/.+\.md$')

# lintå®Ÿè¡Œ
echo "ğŸ§¹ ESLint/Prettierå®Ÿè¡Œä¸­..."
if grep -q "\"lint-staged\"" package.json; then
  pnpm lint-staged
  lint_result=$?
else
  pnpm lint
  lint_result=$?
fi

# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«é–¢é€£ã™ã‚‹å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
if [ ! -z "$js_ts_files" ]; then
  echo "ğŸ§ª å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
  if grep -q "\"test:changed\"" package.json; then
    pnpm test:changed
    test_result=$?
  else
    pnpm vitest --findRelatedTests $js_ts_files --passWithNoTests
    test_result=$?
  fi
else
  echo "ğŸ“ ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãªã—ã€‚ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—"
  test_result=0
fi

# å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
echo "ğŸ“˜ å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm type-check
type_check_result=$?

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆé‡å¤§ãªå•é¡Œã®ã¿ï¼‰
echo "ğŸ”’ é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
pnpm audit --production --audit-level=critical
security_result=$?

# rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
rules_check_result=0
if [ ! -z "$rules_files" ]; then
  echo "ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ä¸­..."

  for file in $rules_files; do
    echo "  - $file ã‚’æ¤œè¨¼ä¸­..."

    # ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
    if [ ! -s "$file" ]; then
      echo "    âŒ $file ãŒç©ºã§ã™"
      rules_check_result=1
      continue
    fi

    # Markdownã®åŸºæœ¬çš„ãªæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã®å­˜åœ¨ç¢ºèªï¼‰
    if ! grep -q "^# " "$file"; then
      echo "    âš ï¸ $file ã«é©åˆ‡ãªè¦‹å‡ºã—(#)ãŒã‚ã‚Šã¾ã›ã‚“"
      rules_check_result=1
    fi

    # å†…éƒ¨ãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
    broken_links=$(grep -o "\[.*\](.*\.md)" "$file" | grep -v "http" | sed 's/.*(\(.*\))/\1/' | while read link; do
      linked_file=$(echo "$link" | sed 's/#.*//')
      if [ ! -z "$linked_file" ] && [ ! -f "$(dirname "$file")/$linked_file" ]; then
        echo "$linked_file"
      fi
    done)

    if [ ! -z "$broken_links" ]; then
      echo "    âš ï¸ $file ã«ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã™: $broken_links"
      rules_check_result=1
    fi

    # å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèªï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åŸºã¥ã„ã¦ï¼‰
    if [[ "$file" == *"_requirements"* ]]; then
      if ! grep -q "^## " "$file"; then
        echo "    âš ï¸ $file ã«è¦ä»¶å®šç¾©ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³(##)ãŒã‚ã‚Šã¾ã›ã‚“"
        rules_check_result=1
      fi
    fi

    # ã‚¹ãƒšãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆåŸºæœ¬çš„ãªè‹±èªã‚¹ãƒšãƒ«ãƒŸã‚¹ï¼‰- ã‚ªãƒ—ã‚·ãƒ§ãƒ³
    if command -v aspell &> /dev/null; then
      spell_errors=$(cat "$file" | aspell list --lang=en | sort -u | head -5)
      if [ ! -z "$spell_errors" ]; then
        echo "    â„¹ï¸ $file ã«ã‚¹ãƒšãƒ«ãƒŸã‚¹ã®å¯èƒ½æ€§: ${spell_errors[*]}"
      fi
    fi
  done
else
  echo "ğŸ“ ruleså¤‰æ›´ãªã—ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—"
fi

# å®Ÿè¡Œçµ‚äº†æ™‚é–“ã¨çµæœè¡¨ç¤º
if [ $lint_result -ne 0 ] || [ $test_result -ne 0 ] || [ $type_check_result -ne 0 ] || [ $security_result -ne 0 ] || [ $rules_check_result -ne 0 ]; then
  echo "âŒ ãƒã‚§ãƒƒã‚¯å¤±æ•—:"
  [ $lint_result -ne 0 ] && echo "  - Lintã‚¨ãƒ©ãƒ¼"
  [ $test_result -ne 0 ] && echo "  - ãƒ†ã‚¹ãƒˆå¤±æ•—"
  [ $type_check_result -ne 0 ] && echo "  - å‹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼"
  [ $security_result -ne 0 ] && echo "  - é‡å¤§ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å•é¡Œ"
  [ $rules_check_result -ne 0 ] && echo "  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ¤œè¨¼ã‚¨ãƒ©ãƒ¼"
  exit 1
else
  echo "âœ… ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼ã‚³ãƒŸãƒƒãƒˆã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  exit 0
fi