#!/bin/sh

echo "ğŸ”„ ãƒãƒ¼ã‚¸å¾Œã®å‡¦ç†ã‚’å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# ãƒãƒ¼ã‚¸å‰å¾Œã®ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’å–å¾—
PREV_HEAD=$(git rev-parse ORIG_HEAD)
CURRENT_HEAD=$(git rev-parse HEAD)
echo "ğŸ“‹ å¤‰æ›´: $(git log --oneline $PREV_HEAD..$CURRENT_HEAD | wc -l) ã‚³ãƒŸãƒƒãƒˆ"

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
changed_files=$(git diff-tree -r --name-only --no-commit-id $PREV_HEAD $CURRENT_HEAD)

# ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ã‚’æ¤œå‡º
if echo "$changed_files" | grep -q "package.json\|pnpm-lock.yaml"; then
  echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™..."
  pnpm install
fi

# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º
if echo "$changed_files" | grep -q "migrations\|schema.sql\|db/schema"; then
  echo "ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸ"

  # package.jsonã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã‚’ç¢ºèª
  if grep -q "\"db:migrate\"" package.json; then
    echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
    pnpm db:migrate
  elif grep -q "\"migrate\"" package.json; then
    echo "ğŸ”„ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œä¸­..."
    pnpm migrate
  else
    echo "âš ï¸ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
  fi
fi

# ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º
if echo "$changed_files" | grep -q ".env.example\|.env.template"; then
  echo "âš™ï¸ ç’°å¢ƒè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã®æ›´æ–°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
fi

# ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®æ¤œå‡º
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
if grep -q "\"test:all\"" package.json; then
  pnpm test:all
  test_result=$?
elif grep -q "\"test:integration\"" package.json; then
  pnpm test:integration
  test_result=$?
else
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ†ã‚¹ãƒˆã‚³ãƒãƒ³ãƒ‰
  pnpm test
  test_result=$?
fi

# ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æœ‰ç„¡ã‚’ç¢ºèª
if echo "$changed_files" | grep -q "webpack\|vite\|tsconfig\|next.config"; then
  echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰è¨­å®šã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
  if grep -q "\"build\"" package.json; then
    pnpm build
    build_result=$?
    if [ $build_result -ne 0 ]; then
      echo "âš ï¸ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
    fi
  fi
fi

# å‹ãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ
if echo "$changed_files" | grep -q "\.tsx\?\|tsconfig"; then
  echo "ğŸ“˜ TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™..."
  if grep -q "\"type-check\"" package.json; then
    pnpm type-check
    type_check_result=$?
    if [ $type_check_result -ne 0 ]; then
      echo "âš ï¸ å‹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    fi
  fi
fi

# ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã€è­¦å‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŒå‡¦ç†ã¯ç¶šè¡Œ
if [ $test_result -ne 0 ]; then
  echo "âš ï¸ ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ãŒå¿…è¦ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚"
else
  echo "âœ… ãƒ†ã‚¹ãƒˆã«æˆåŠŸã—ã¾ã—ãŸï¼"
fi

# è¦ç´„ã‚’è¡¨ç¤º
echo ""
echo "====== ãƒãƒ¼ã‚¸å¾Œã®å‡¦ç†å®Œäº† ======"
echo "ğŸ“ å¤‰æ›´æ¦‚è¦:"
git log --pretty=format:"- %s" $PREV_HEAD..$CURRENT_HEAD | head -n 5
echo ""
echo "å¯¾å¿œãŒå¿…è¦ãªå¯èƒ½æ€§ã®ã‚ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:"
[ "$test_result" -ne 0 ] && echo "- ãƒ†ã‚¹ãƒˆå¤±æ•—ã®ä¿®æ­£"
echo "$changed_files" | grep -q "package.json" && echo "- æ–°ã—ã„ä¾å­˜é–¢ä¿‚ã®ç¢ºèª"
echo "$changed_files" | grep -q "migrations" && echo "- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèª"
echo "$changed_files" | grep -q ".env.example" && echo "- ç’°å¢ƒå¤‰æ•°ã®æ›´æ–°"

echo "âœ… ãƒãƒ¼ã‚¸å¾Œã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
exit 0