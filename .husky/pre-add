#!/bin/sh

echo "ğŸ” git addå‰ã«ç°¡æ˜“ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ"

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
all_staged_files=$(git diff --cached --name-only --diff-filter=ACM)
js_ts_files=$(echo "$all_staged_files" | grep -E '\.tsx?$|\.jsx?$' || true)
rules_md_files=$(echo "$all_staged_files" | grep -E '^rules/.+\.md$' || true)

# JS/TSãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€lint ã¨ format ã‚’å®Ÿè¡Œ
if [ ! -z "$js_ts_files" ]; then
  echo "ğŸ§¹ ESLintå®Ÿè¡Œä¸­..."
  # lint-stagedã‚’å„ªå…ˆä½¿ç”¨
  if [ -f "lint-staged.config.js" ]; then
    pnpm lint-staged
    lint_result=$?
  else
    pnpm lint
    lint_result=$?
  fi

  if [ $lint_result -ne 0 ]; then
    echo "âŒ Lintã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ git add ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    exit 1
  fi

  echo "ğŸ’… Prettierå®Ÿè¡Œä¸­..."
  pnpm format
  format_result=$?

  if [ $format_result -ne 0 ]; then
    echo "âŒ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ git add ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    exit 1
  fi

  echo "âœ… Lintã¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯æˆåŠŸï¼"
fi

# rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®Markdownãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹å ´åˆ
if [ ! -z "$rules_md_files" ]; then
  echo "ğŸ“ rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å¤‰æ›´ã‚’æ¤œå‡ºã€‚åŸºæœ¬æ¤œè¨¼ã‚’å®Ÿè¡Œ..."
  rules_errors=0

  for file in $rules_md_files; do
    # ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼
    echo "  - $file ã®åŸºæœ¬æ¤œè¨¼ä¸­..."

    # 1. ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ãªã„ã“ã¨ã‚’ç¢ºèª
    if [ ! -s "$file" ]; then
      echo "    âŒ $file ãŒç©ºã§ã™"
      rules_errors=1
      continue
    fi

    # 2. æœ€ä½é™ã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
    if ! grep -q "^# " "$file"; then
      echo "    âš ï¸ $file ã«é©åˆ‡ãªè¦‹å‡ºã—(#)ãŒã‚ã‚Šã¾ã›ã‚“"
    fi

    # 3. æ–‡æ³•ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆä¸å®Œå…¨ãªè¦‹å‡ºã—ã‚„ç®‡æ¡æ›¸ãï¼‰
    if grep -q "^#\s*$" "$file" || grep -q "^-\s*$" "$file"; then
      echo "    âš ï¸ $file ã«ä¸å®Œå…¨ãªè¦‹å‡ºã—ã¾ãŸã¯ç®‡æ¡æ›¸ããŒã‚ã‚Šã¾ã™"
    fi
  done

  if [ $rules_errors -ne 0 ]; then
    echo "âŒ rulesãƒ•ã‚¡ã‚¤ãƒ«ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ git add ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
    exit 1
  else
    echo "âœ… rulesãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ¤œè¨¼ã«æˆåŠŸã—ã¾ã—ãŸ"
  fi
fi

# JS/TSãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
if [ -z "$js_ts_files" ]; then
  echo "ğŸ“ JSã¾ãŸã¯TSãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  exit 0
fi

# ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
file_count=$(echo "$js_ts_files" | wc -l)
if [ $file_count -gt 10 ]; then
  echo "âš ï¸ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°ãŒå¤šã„(${file_count}å€‹)ã€‚è©³ç´°ãƒ†ã‚¹ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  exit 0
fi

# é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ï¼‰
echo "ğŸ§ª å¤‰æ›´é–¢é€£ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
# å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ(åŠ¹ç‡çš„ãªæ–¹æ³•)
NODE_OPTIONS="--max-old-space-size=4096" pnpm vitest related --run $(git diff --name-only --staged | grep -E '\.tsx?$|\.jsx?$') --passWithNoTests
test_exit_code=$?

if [ $test_exit_code -ne 0 ]; then
  echo "âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—ã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
  exit 1
else
  echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸï¼ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  exit 0
fi