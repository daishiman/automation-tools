#!/bin/sh

echo "ğŸ” ãƒ—ãƒƒã‚·ãƒ¥å‰ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD)
target_branch=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null | sed 's/origin\///')

# ãƒ–ãƒ©ãƒ³ãƒã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
is_main_branch=false
if [[ "$current_branch" == "main" || "$current_branch" == "dev" || "$target_branch" == "main" || "$target_branch" == "dev" ]]; then
  is_main_branch=true
  echo "ğŸ“£ main/devãƒ–ãƒ©ãƒ³ãƒã¸ã®/ã‹ã‚‰ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - å®Œå…¨ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
else
  echo "ğŸ“£ é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - åŸºæœ¬ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
fi

# å®Ÿè¡Œé–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
start_time=$(date +%s)

# å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
echo "ğŸ“ å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm type-check
typecheck_result=$?

# ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦æŒ™å‹•å¤‰æ›´ï¼‰
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
if [ "$is_main_branch" = true ]; then
  # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š (ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç›®æ¨™ï¼šé‡è¦ãƒ­ã‚¸ãƒƒã‚¯70%ä»¥ä¸Š)
  if grep -q "\"test:coverage\"" package.json; then
    pnpm test:coverage
  else
    pnpm vitest run --coverage
  fi
  coverage_result=$?
  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ä»¥ä¸‹ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
  coverage_file=$(find . -name "coverage-summary.json" -type f | head -n 1)
  if [ -n "$coverage_file" ]; then
    coverage_percent=$(cat $coverage_file | grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9]*\.[0-9]*' | grep -o 'pct":[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*')
    if (( $(echo "$coverage_percent < 70" | bc -l) )); then
      echo "âš ï¸ ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ã«é”ã—ã¦ã„ã¾ã›ã‚“: $coverage_percent% (ç›®æ¨™: 70%)"
      coverage_low=1
    else
      coverage_low=0
    fi
  else
    echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    coverage_low=0
  fi
else
  # é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã§ã¯é«˜é€Ÿãƒ†ã‚¹ãƒˆ
  pnpm vitest run --bail
  coverage_result=0
  coverage_low=0
fi
test_result=$?

# ESLintãƒã‚§ãƒƒã‚¯
echo "ğŸ§¹ ESLintå®Ÿè¡Œä¸­..."
pnpm lint
lint_result=$?

# ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ’… Prettierå®Ÿè¡Œä¸­..."
if grep -q "\"format\"" package.json; then
  pnpm format
elif grep -q "\"fmt\"" package.json; then
  pnpm fmt
else
  echo "ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi
format_result=$?

# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm audit --production
security_result=$?

# rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯ï¼ˆmain/devãƒ–ãƒ©ãƒ³ãƒã§ã¯å¿…é ˆï¼‰
echo "ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if [ -d "rules" ]; then
  # ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
  all_rules_files=$(find rules -name "*.md")
  rules_error=0
  rules_warnings=0

  # ãƒ«ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
  required_dirs=("0_common" "1_business_requirements" "2_backend_functional_requirements"
                 "3_frontend_functional_requirements" "4_nonFunctional_requirements"
                 "5_development_process" "6_risk_and_release_plan")

  for dir in "${required_dirs[@]}"; do
    if [ ! -d "rules/$dir" ]; then
      echo "âŒ å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä¸è¶³: rules/$dir"
      rules_error=1
    fi
  done

  # README.mdã®å­˜åœ¨ç¢ºèª
  if [ ! -f "rules/README.md" ]; then
    echo "âŒ rules/README.mdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    rules_error=1
  fi

  # å„Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
  for file in $all_rules_files; do
    # ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
    if ! grep -q "^# " "$file"; then
      echo "âš ï¸ $file ã«ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼(#)ãŒã‚ã‚Šã¾ã›ã‚“"
      rules_warnings=$((rules_warnings + 1))
    fi

    # ãƒ•ã‚¡ã‚¤ãƒ«å†…ãƒªãƒ³ã‚¯ç¢ºèª
    broken_links=$(grep -o "\[.*\](.*\.md)" "$file" | grep -v "http" | sed 's/.*(\(.*\))/\1/' | while read link; do
      linked_file=$(echo "$link" | sed 's/#.*//')
      if [ ! -z "$linked_file" ] && [ ! -f "$(dirname "$file")/$linked_file" ]; then
        echo "$linked_file"
      fi
    done)

    if [ ! -z "$broken_links" ]; then
      echo "âš ï¸ $file ã«ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã™: $broken_links"
      rules_warnings=$((rules_warnings + 1))
    fi

    # ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ãæ¤œè¨¼
    if [[ "$file" == *"requirements"* ]]; then
      # è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å¿…ãšè¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦
      section_count=$(grep -c "^## " "$file")
      if [ "$section_count" -lt 2 ]; then
        echo "âš ï¸ $file ã®è¦ä»¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³(##)ãŒä¸è¶³ã—ã¦ã„ã¾ã™($section_countå€‹ã®ã¿)"
        rules_warnings=$((rules_warnings + 1))
      fi
    fi
  done

  # å‚ç…§æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé–“ã®ç›¸äº’å‚ç…§ï¼‰
  echo "ğŸ”„ è¦ä»¶ã®å‚ç…§æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
  if [ -d "rules/1_business_requirements" ] && [ -d "rules/2_backend_functional_requirements" ]; then
    business_req=$(grep -r "^## [0-9]\." "rules/1_business_requirements" | sed 's/.*## \([0-9]\.[0-9]*\).*/\1/' | sort)
    backend_imp=$(grep -r "å¯¾å¿œã™ã‚‹æ¥­å‹™è¦ä»¶:" "rules/2_backend_functional_requirements" | sed 's/.*å¯¾å¿œã™ã‚‹æ¥­å‹™è¦ä»¶: \([0-9]\.[0-9,]*\).*/\1/' | tr ',' '\n' | sort -u)

    # ç›¸äº’å‚ç…§ã®ç¢ºèªã¯ã€main/devãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿å³æ ¼ã«
    if [ "$is_main_branch" = true ]; then
      for req in $business_req; do
        if ! echo "$backend_imp" | grep -q "$req"; then
          echo "âš ï¸ æ¥­å‹™è¦ä»¶ $req ã®å®Ÿè£…å‚ç…§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          rules_warnings=$((rules_warnings + 1))
        fi
      done
    fi
  fi

  if [ "$rules_error" -ne 0 ]; then
    echo "âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚ä¿®æ­£ãŒå¿…è¦ã§ã™ã€‚"
    rules_check_result=1
  elif [ "$rules_warnings" -gt 0 ] && [ "$is_main_branch" = true ]; then
    echo "âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«$rules_warningså€‹ã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™ã€‚"
    rules_check_result=1
  else
    echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
    rules_check_result=0
  fi
else
  echo "ğŸ“ rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  rules_check_result=0
fi

# main/devãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œã™ã‚‹è¿½åŠ ãƒã‚§ãƒƒã‚¯
if [ "$is_main_branch" = true ]; then
  # ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
  if grep -q "\"build\"" package.json; then
    pnpm build
    build_result=$?
  else
    echo "ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    build_result=0
  fi
else
  build_result=0
fi

# å®Ÿè¡Œçµ‚äº†æ™‚é–“ã‚’è¨˜éŒ²
end_time=$(date +%s)
execution_time=$((end_time - start_time))

# çµæœã®è¡¨ç¤º
echo "============================="
echo "ğŸ” å®Ÿè¡Œçµæœ"

# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®š
if [ $typecheck_result -ne 0 ] || [ $test_result -ne 0 ] || [ $format_result -ne 0 ] || [ $lint_result -ne 0 ] || [ $security_result -ne 0 ] || [ $build_result -ne 0 ] || [ $coverage_low -ne 0 ] || [ $rules_check_result -ne 0 ]; then
  echo "âŒ ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—:"
  [ $typecheck_result -ne 0 ] && echo "  - å‹ãƒã‚§ãƒƒã‚¯"
  [ $test_result -ne 0 ] && echo "  - ãƒ†ã‚¹ãƒˆ"
  [ $format_result -ne 0 ] && echo "  - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ"
  [ $lint_result -ne 0 ] && echo "  - ESLint"
  [ $security_result -ne 0 ] && echo "  - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
  [ $build_result -ne 0 ] && echo "  - ãƒ“ãƒ«ãƒ‰"
  [ $coverage_low -ne 0 ] && echo "  - ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ä¸è¶³"
  [ $rules_check_result -ne 0 ] && echo "  - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§"
  exit_code=1
else
  echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯æˆåŠŸ"
  exit_code=0
fi

echo "â±ï¸ åˆè¨ˆå®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ (main/devã®ã¿ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
if [ "$is_main_branch" = true ] && [ -f "node_modules/.bin/lighthouse" ]; then
  echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ(y/N): "
  read -n 1 -r
  echo    # æ”¹è¡Œ
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
    node_modules/.bin/lighthouse http://localhost:3000 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless" --throttling.cpuSlowdownMultiplier=4
    # çµæœç¢ºèª
    ttfb=$(cat lighthouse-report.json | grep -o '"time-to-first-byte":{[^}]*}' | grep -o '"numericValue":[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*')
    if (( $(echo "$ttfb > 500" | bc -l) )); then
      echo "âš ï¸ TTFBãŒç›®æ¨™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™: ${ttfb}ms (ç›®æ¨™: 500msä»¥å†…)"
    else
      echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™é”æˆ: TTFB ${ttfb}ms"
    fi
  fi
fi

exit $exit_code