#!/bin/sh

echo "ğŸ” ãƒ—ãƒƒã‚·ãƒ¥å‰ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
start_time=$(date +%s)

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD)
target_branch=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null | sed 's/origin\///')

# ãƒ–ãƒ©ãƒ³ãƒã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
is_main_branch=false
if [[ "$current_branch" == "main" || "$current_branch" == "dev" || "$target_branch" == "main" || "$target_branch" == "dev" ]]; then
  is_main_branch=true
  echo "ğŸ“£ main/devãƒ–ãƒ©ãƒ³ãƒã¸ã®/ã‹ã‚‰ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - å®Œå…¨ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
else
  echo "ğŸ“£ é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - åŸºæœ¬ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
fi

# ãƒã‚§ãƒƒã‚¯çµæœã‚’è¿½è·¡ã™ã‚‹å¤‰æ•°
errors=0
warnings=0

# ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°: ãƒã‚§ãƒƒã‚¯çµæœã®è¡¨ç¤ºã¨è¿½è·¡
check_result() {
  local result=$1
  local message=$2
  local error_type=$3

  if [ $result -ne 0 ]; then
    if [ "$error_type" = "warning" ]; then
      echo "âš ï¸ $message"
      warnings=$((warnings + 1))
    else
      echo "âŒ $message"
      errors=$((errors + 1))
    fi
    return 1
  else
    echo "âœ… $message"
    return 0
  fi
}

# 1. å‹ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
echo "ğŸ“ å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm type-check
check_result $? "å‹ãƒã‚§ãƒƒã‚¯å®Œäº†" "error"
typecheck_result=$?

# 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦æŒ™å‹•å¤‰æ›´ï¼‰
echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
if [ "$is_main_branch" = true ]; then
  # ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š (ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã®ç›®æ¨™ï¼šé‡è¦ãƒ­ã‚¸ãƒƒã‚¯70%ä»¥ä¸Š)
  if grep -q "\"test:coverage\"" package.json; then
    pnpm test:coverage
  else
    pnpm vitest run --coverage
  fi
  test_result=$?

  # ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ä»¥ä¸‹ã®å ´åˆã¯è­¦å‘Š
  coverage_file=$(find . -name "coverage-summary.json" -type f | head -n 1)
  if [ -n "$coverage_file" ]; then
    coverage_percent=$(cat $coverage_file | grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9]*\.[0-9]*' | grep -o 'pct":[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*')
    if (( $(echo "$coverage_percent < 70" | bc -l) )); then
      echo "âš ï¸ ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ã«é”ã—ã¦ã„ã¾ã›ã‚“: $coverage_percent% (ç›®æ¨™: 70%)"
      warnings=$((warnings + 1))
    else
      echo "âœ… ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸: $coverage_percent% (ç›®æ¨™: 70%)"
    fi
  else
    echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    warnings=$((warnings + 1))
  fi
else
  # é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã§ã¯é«˜é€Ÿãƒ†ã‚¹ãƒˆ
  pnpm vitest run --bail
  test_result=$?
fi

check_result $test_result "ãƒ†ã‚¹ãƒˆå®Œäº†" "error"

# 3. ESLintãƒã‚§ãƒƒã‚¯
echo "ğŸ§¹ ESLintå®Ÿè¡Œä¸­..."
pnpm lint
check_result $? "ESLintå®Œäº†" "error"
lint_result=$?

# 4. ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
echo "ğŸ’… Prettierå®Ÿè¡Œä¸­..."
if grep -q "\"format\"" package.json; then
  pnpm format
  check_result $? "Prettierå®Ÿè¡Œå®Œäº†" "warning"
elif grep -q "\"fmt\"" package.json; then
  pnpm fmt
  check_result $? "Prettierå®Ÿè¡Œå®Œäº†" "warning"
else
  echo "â„¹ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
fi
format_result=$?

# 5. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (è­¦å‘Šã¨ã—ã¦æ‰±ã†)
echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm audit --production
security_result=$?
if [ $security_result -ne 0 ]; then
  echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚å°†æ¥çš„ã«ä¿®æ­£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
  warnings=$((warnings + 1))
else
  echo "âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Œäº†"
fi

# 6. main/devãƒ–ãƒ©ãƒ³ãƒã®ã¿å®Ÿè¡Œã™ã‚‹è¿½åŠ ãƒã‚§ãƒƒã‚¯
if [ "$is_main_branch" = true ]; then
  # ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
  if grep -q "\"build\"" package.json; then
    pnpm build
    check_result $? "ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Œäº†" "error"
    build_result=$?
  else
    echo "â„¹ï¸ ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    build_result=0
  fi

  # 7. rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åŒ…æ‹¬çš„ãƒã‚§ãƒƒã‚¯ï¼ˆmain/devãƒ–ãƒ©ãƒ³ãƒã§ã¯å¿…é ˆï¼‰
  echo "ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
  rules_check_result=0

  # rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  if [ -d "rules" ]; then
    # ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œè¨¼
    all_rules_files=$(find rules -name "*.md")
    rules_warnings=0

    # ãƒ«ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ãƒã‚§ãƒƒã‚¯
    required_dirs=("0_common" "1_business_requirements" "2_backend_functional_requirements"
                  "3_frontend_functional_requirements" "4_nonFunctional_requirements"
                  "5_development_process" "6_risk_and_release_plan")

    for dir in "${required_dirs[@]}"; do
      if [ ! -d "rules/$dir" ]; then
        echo "âŒ å¿…é ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒä¸è¶³: rules/$dir"
        rules_check_result=1
      fi
    done

    # README.mdã®å­˜åœ¨ç¢ºèª
    if [ ! -f "rules/README.md" ]; then
      echo "âŒ rules/README.mdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
      rules_check_result=1
    fi

    # å„Markdownãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
    for file in $all_rules_files; do
      # ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
      if ! grep -q "^# " "$file"; then
        echo "âš ï¸ $file ã«ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼(#)ãŒã‚ã‚Šã¾ã›ã‚“"
        rules_warnings=$((rules_warnings + 1))
      fi

      # ãƒ•ã‚¡ã‚¤ãƒ«å†…ãƒªãƒ³ã‚¯ç¢ºèª
      broken_links=$(grep -o "\[.*\](.*\.md)" "$file" | grep -v "http" | sed 's/.*(\(.*\))/\1/' | while read link; do
        linked_file=$(echo "$link" | sed 's/#.*//')
        if [ ! -z "$linked_file" ] && [ ! -f "$(dirname "$file")/$linked_file" ]; then
          echo "$linked_file"
        fi
      done)

      if [ ! -z "$broken_links" ]; then
        echo "âš ï¸ $file ã«ç„¡åŠ¹ãªãƒªãƒ³ã‚¯ãŒã‚ã‚Šã¾ã™: $broken_links"
        rules_warnings=$((rules_warnings + 1))
      fi

      # ç‰¹å®šã®ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ãæ¤œè¨¼
      if [[ "$file" == *"requirements"* ]]; then
        # è¦ä»¶å®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯å¿…ãšè¤‡æ•°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦
        section_count=$(grep -c "^## " "$file")
        if [ "$section_count" -lt 2 ]; then
          echo "âš ï¸ $file ã®è¦ä»¶ã‚»ã‚¯ã‚·ãƒ§ãƒ³(##)ãŒä¸è¶³ã—ã¦ã„ã¾ã™($section_countå€‹ã®ã¿)"
          rules_warnings=$((rules_warnings + 1))
        fi
      fi
    done

    # å‚ç…§æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé–“ã®ç›¸äº’å‚ç…§ï¼‰
    echo "ğŸ”„ è¦ä»¶ã®å‚ç…§æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    if [ -d "rules/1_business_requirements" ] && [ -d "rules/2_backend_functional_requirements" ]; then
      business_req=$(grep -r "^## [0-9]\." "rules/1_business_requirements" | sed 's/.*## \([0-9]\.[0-9]*\).*/\1/' | sort)
      backend_imp=$(grep -r "å¯¾å¿œã™ã‚‹æ¥­å‹™è¦ä»¶:" "rules/2_backend_functional_requirements" | sed 's/.*å¯¾å¿œã™ã‚‹æ¥­å‹™è¦ä»¶: \([0-9]\.[0-9,]*\).*/\1/' | tr ',' '\n' | sort -u)

      # ç›¸äº’å‚ç…§ã®ç¢ºèªã¯ã€main/devãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã®ã¿å³æ ¼ã«
      for req in $business_req; do
        if ! echo "$backend_imp" | grep -q "$req"; then
          echo "âš ï¸ æ¥­å‹™è¦ä»¶ $req ã®å®Ÿè£…å‚ç…§ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          rules_warnings=$((rules_warnings + 1))
        fi
      done
    fi

    if [ "$rules_check_result" -ne 0 ]; then
      echo "âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹é€ ã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™"
      errors=$((errors + 1))
    elif [ "$rules_warnings" -gt 0 ]; then
      echo "âš ï¸ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«$rules_warningså€‹ã®è­¦å‘ŠãŒã‚ã‚Šã¾ã™"
      warnings=$((warnings + 1))
    else
      echo "âœ… ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å®Œäº†"
    fi
  else
    echo "ğŸ“ rulesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
  fi
else
  build_result=0
fi

# å®Ÿè¡Œçµ‚äº†æ™‚é–“ã‚’è¨˜éŒ²
end_time=$(date +%s)
execution_time=$((end_time - start_time))

# çµæœã®è¡¨ç¤º
echo "============================="
echo "ğŸ” å®Ÿè¡Œçµæœ"

if [ $errors -gt 0 ]; then
  echo "âŒ ãƒã‚§ãƒƒã‚¯å¤±æ•—: $errors å€‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
  echo "âš ï¸ è­¦å‘Š: $warnings å€‹"
  exit_code=1
elif [ $warnings -gt 0 ] && [ "$is_main_branch" = true ]; then
  echo "âš ï¸ main/devãƒ–ãƒ©ãƒ³ãƒã§ã®è­¦å‘Š: $warnings å€‹ï¼ˆä¿®æ­£ã‚’æ¨å¥¨ï¼‰"
  echo "âœ… é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“"
  exit_code=0
else
  echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼"
  exit_code=0
fi

echo "â±ï¸ åˆè¨ˆå®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ (main/devã®ã¿ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
if [ "$is_main_branch" = true ] && [ -f "node_modules/.bin/lighthouse" ]; then
  echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ(y/N): "
  read -n 1 -r
  echo    # æ”¹è¡Œ
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    echo "âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
    node_modules/.bin/lighthouse http://localhost:3000 --output=json --output-path=./lighthouse-report.json --chrome-flags="--headless" --throttling.cpuSlowdownMultiplier=4
    # çµæœç¢ºèª
    ttfb=$(cat lighthouse-report.json | grep -o '"time-to-first-byte":{[^}]*}' | grep -o '"numericValue":[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*')
    if (( $(echo "$ttfb > 500" | bc -l) )); then
      echo "âš ï¸ TTFBãŒç›®æ¨™å€¤ã‚’è¶…ãˆã¦ã„ã¾ã™: ${ttfb}ms (ç›®æ¨™: 500msä»¥å†…)"
    else
      echo "âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›®æ¨™é”æˆ: TTFB ${ttfb}ms"
    fi
  fi
fi

exit $exit_code