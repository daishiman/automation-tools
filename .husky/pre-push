#!/bin/sh
# ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«ç®¡ç†

echo "ğŸ” ãƒ—ãƒƒã‚·ãƒ¥å‰ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
cd "$(git rev-parse --show-toplevel)"

# é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
start_time=$(date +%s)

# ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
current_branch=$(git symbolic-ref --short HEAD)
target_branch=$(git rev-parse --abbrev-ref @{upstream} 2>/dev/null | sed 's/origin\///')

# ãƒ–ãƒ©ãƒ³ãƒã«ã‚ˆã‚‹æ¡ä»¶åˆ†å²
is_main_branch=false
if [[ "$current_branch" == "main" || "$current_branch" == "dev" || "$target_branch" == "main" || "$target_branch" == "dev" ]]; then
  is_main_branch=true
  echo "ğŸ“£ main/devãƒ–ãƒ©ãƒ³ãƒã¸ã®/ã‹ã‚‰ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - å®Œå…¨ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
else
  echo "ğŸ“£ é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã‚’æ¤œå‡º - åŸºæœ¬ãƒã‚§ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰"
  echo "ğŸŒ ç¾åœ¨: $current_branch â†’ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${target_branch:-æœªè¨­å®š}"
fi

# ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸã‹ã©ã†ã‹ã‚’è¿½è·¡
has_errors=0
has_warnings=0

# 1. å‹ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰
echo "ğŸ“ å‹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
pnpm type-check
type_check_result=$?

if [ $type_check_result -ne 0 ]; then
  echo "âŒ å‹ãƒã‚§ãƒƒã‚¯ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
  has_errors=1
else
  echo "âœ… å‹ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼"
fi

# 2. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºãªã„ã‚ˆã†ã«ä¿®æ­£ï¼‰
if [ $has_errors -eq 0 ]; then
  echo "ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."

  if [ "$is_main_branch" = true ]; then
    # main/devãƒ–ãƒ©ãƒ³ãƒã§ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ã‚‚å®Ÿæ–½
    if grep -q "\"test:coverage\"" package.json; then
      # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ
      timeout 180s NODE_OPTIONS="--max-old-space-size=4096" pnpm test:coverage || echo "âš ï¸ ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
    else
      # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ
      timeout 180s NODE_OPTIONS="--max-old-space-size=4096" pnpm vitest run --coverage || echo "âš ï¸ ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
    fi
    test_result=$?

    if [ $test_result -eq 124 ]; then
      echo "âš ï¸ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
      has_warnings=1
      test_result=0
    fi

    # ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™ã®ç¢ºèªï¼ˆ70%ä»¥ä¸Šï¼‰
    coverage_file=$(find . -name "coverage-summary.json" -type f | head -n 1)
    if [ -n "$coverage_file" ]; then
      coverage_percent=$(cat $coverage_file | grep -o '"lines":{"total":[0-9]*,"covered":[0-9]*,"skipped":[0-9]*,"pct":[0-9]*\.[0-9]*' | grep -o 'pct":[0-9]*\.[0-9]*' | grep -o '[0-9]*\.[0-9]*')
      if (( $(echo "$coverage_percent < 70" | bc -l) )); then
        echo "âš ï¸ ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒç›®æ¨™å€¤ã«é”ã—ã¦ã„ã¾ã›ã‚“: $coverage_percent% (ç›®æ¨™: 70%)"
        has_warnings=1
      else
        echo "âœ… ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸: $coverage_percent% (ç›®æ¨™: 70%)"
      fi
    else
      echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
      has_warnings=1
    fi
  else
    # é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã§ã¯åŸºæœ¬ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ
    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãã§å®Ÿè¡Œ (3åˆ†)
    timeout 180s NODE_OPTIONS="--max-old-space-size=4096" pnpm vitest run --no-threads || echo "âš ï¸ ãƒ†ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"
    test_result=$?

    if [ $test_result -eq 124 ]; then
      echo "âš ï¸ ãƒ†ã‚¹ãƒˆã®å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
      has_warnings=1
      test_result=0
    fi
  fi

  if [ $test_result -ne 0 ]; then
    echo "âŒ ãƒ†ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
    has_errors=1
  else
    echo "âœ… ãƒ†ã‚¹ãƒˆæˆåŠŸï¼"
  fi
fi

# 3. æœ€å°é™ã®Lintãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¯¾ç­–ï¼‰
if [ $has_errors -eq 0 ]; then
  echo "ğŸ§¹ ESLintã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."

  # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
  changed_js_ts_files=$(git diff --name-only --diff-filter=ACM origin/dev..HEAD | grep -E '\.tsx?$|\.jsx?$' || echo "")

  if [ -n "$changed_js_ts_files" ]; then
    # æœ€å¤§10ãƒ•ã‚¡ã‚¤ãƒ«ã¾ã§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å¯¾ç­–ï¼‰
    files_to_check=$(echo "$changed_js_ts_files" | head -n 10)
    timeout 30s pnpm eslint $files_to_check --quiet
    lint_result=$?

    if [ $lint_result -eq 124 ]; then
      echo "âš ï¸ ESLintã®å®Ÿè¡ŒãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
      has_warnings=1
      lint_result=0
    elif [ $lint_result -ne 0 ]; then
      echo "âŒ Lintã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
      has_errors=1
    else
      echo "âœ… åŸºæœ¬çš„ãªLintãƒã‚§ãƒƒã‚¯æˆåŠŸï¼"
    fi
  else
    echo "ğŸ“ JS/TSãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—ã€‚Lintãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
  fi
fi

# 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã¨ã—ã¦æ‰±ã†ï¼‰
echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã¯ã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ã™ã‚‹
timeout 30s pnpm audit --production --audit-level=critical || true
echo "â„¹ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®å•é¡ŒãŒã‚ã‚‹å ´åˆã¯å°†æ¥çš„ã«å¯¾å¿œã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
has_warnings=1

# 5. main/devãƒ–ãƒ©ãƒ³ãƒã®å ´åˆã¯ãƒ“ãƒ«ãƒ‰ã‚‚å®Ÿè¡Œ
if [ $has_errors -eq 0 ] && [ "$is_main_branch" = true ]; then
  echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
  if grep -q "\"build\"" package.json; then
    NODE_OPTIONS="--max-old-space-size=4096" pnpm build
    build_result=$?

    if [ $build_result -ne 0 ]; then
      echo "âŒ ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
      has_errors=1
    else
      echo "âœ… ãƒ“ãƒ«ãƒ‰æˆåŠŸï¼"
    fi
  else
    echo "â„¹ï¸ ãƒ“ãƒ«ãƒ‰ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  fi
fi

# å®Ÿè¡Œçµ‚äº†æ™‚é–“ã¨çµæœè¡¨ç¤º
end_time=$(date +%s)
execution_time=$((end_time - start_time))

echo "============================="
echo "ğŸ” å®Ÿè¡Œçµæœ"

if [ $has_errors -ne 0 ]; then
  echo "âŒ ãƒã‚§ãƒƒã‚¯å¤±æ•—: ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚"
  echo "âš ï¸ è­¦å‘Š: $has_warnings å€‹"
  echo "â±ï¸ å®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"
  exit 1
elif [ $has_warnings -ne 0 ] && [ "$is_main_branch" = true ]; then
  echo "âš ï¸ main/devãƒ–ãƒ©ãƒ³ãƒã§ã®è­¦å‘Š: $has_warnings å€‹ï¼ˆä¿®æ­£ã‚’æ¨å¥¨ï¼‰"
  echo "âœ… é‡å¤§ãªã‚¨ãƒ©ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ—ãƒƒã‚·ãƒ¥ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  echo "â±ï¸ å®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"
  exit 0
else
  echo "âœ… ã™ã¹ã¦ã®ãƒã‚§ãƒƒã‚¯æˆåŠŸï¼ãƒ—ãƒƒã‚·ãƒ¥ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
  echo "â±ï¸ å®Ÿè¡Œæ™‚é–“: ${execution_time}ç§’"
  exit 0
fi