name: é–‹ç™ºç’°å¢ƒ CI/CD

# é–‹ç™ºç’°å¢ƒå‘ã‘ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# å¯¾è±¡: developãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ãƒ»PRã€ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œ
on:
  push:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'rules/**'
  pull_request:
    branches: [develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'rules/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      preview_branch:
        description: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒåï¼ˆfeature/**ãªã©ï¼‰'
        required: false
        type: string

# å®Ÿè¡Œã®æœ€é©åŒ–ï¼ˆåŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢ï¼‰
concurrency:
  group: develop-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå†åˆ©ç”¨å¯èƒ½ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
  setup:
    name: ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    uses: ./.github/workflows/reusable-setup.yml
    with:
      node_version: '20'
      pnpm_version: '8.10.0'
      install_dependencies: true

  # ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼
  # ãƒ—ãƒƒã‚·ãƒ¥ã€PRã€æ‰‹å‹•å®Ÿè¡Œæ™‚ã«å¿…ãšå®Ÿè¡Œã™ã‚‹
  lint-and-test:
    name: å‹ãƒã‚§ãƒƒã‚¯ãƒ»ãƒªãƒ³ãƒˆãƒ»ãƒ†ã‚¹ãƒˆ
    needs: [setup]
    runs-on: ubuntu-latest
    steps:
      - name: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.preview_branch || github.ref }}

      - name: PNPMã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v2
        with:
          version: 8.10.0

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install

      - name: ãƒªãƒ³ãƒˆå®Ÿè¡Œ
        run: pnpm lint

      - name: å‹ãƒã‚§ãƒƒã‚¯
        run: pnpm type-check

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: pnpm test

      - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯
        run: pnpm test:coverage

  # ãƒ†ã‚¹ãƒˆçµæœã®PRã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRã®å ´åˆã®ã¿ï¼‰
  # æ³¨æ„: reusable-test-reporting.ymlãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ä»¥ä¸‹ã®å…¥åŠ›ãŒå¿…è¦ã§ã™
  # - test_type: ãƒ†ã‚¹ãƒˆã®ç¨®é¡ã‚’æŒ‡å®š
  # - junit_path: JUnitãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯'junit.xml'ï¼‰
  # - coverage_path: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯'coverage'ï¼‰
  # - comment_on_pr: PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹ã‹ã©ã†ã‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯falseï¼‰
  # - retention_days: ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿æŒæ—¥æ•°
  test-report:
    name: ãƒ†ã‚¹ãƒˆçµæœãƒ¬ãƒãƒ¼ãƒˆ
    needs: [lint-and-test]
    if: github.event_name == 'pull_request' && always()
    uses: ./.github/workflows/reusable-test-reporting.yml
    with:
      test_type: 'develop-ci'
      coverage_path: 'coverage'
      comment_on_pr: true
      retention_days: 7

  # ã‚¹ãƒ†ãƒƒãƒ—3: é–‹ç™ºç’°å¢ƒå‘ã‘ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œæ™‚ã®ã¿ï¼‰
  # æ³¨æ„: reusable-deploy.ymlãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã¯ä»¥ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãŒå¿…è¦ã§ã™
  # - CF_API_TOKEN: Cloudflare API ãƒˆãƒ¼ã‚¯ãƒ³
  # - CF_ACCOUNT_ID: Cloudflare ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
  # - SLACK_WEBHOOK: Slacké€šçŸ¥ç”¨ã®Webhook URLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  deploy-develop:
    name: é–‹ç™ºç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [lint-and-test]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'development'
      app_url: 'https://512dca79.automationa-tools.pages.dev'
      branch_name: ${{ github.event.inputs.preview_branch || 'develop' }}
      next_public_env: 'development'
      strict_validation: false
      send_notification: false
    secrets:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # ã‚¹ãƒ†ãƒƒãƒ—4: PRæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
  # PRæ™‚ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼‰
  deploy-preview:
    name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: [lint-and-test]
    if: github.event_name == 'pull_request'
    uses: ./.github/workflows/reusable-deploy.yml
    with:
      environment: 'preview'
      app_url: 'https://pr-${{ github.event.pull_request.number }}.automationa-tools.pages.dev'
      branch_name: 'pr-${{ github.event.pull_request.number }}'
      next_public_env: 'development'
      strict_validation: false
      send_notification: false
    secrets:
      CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
      CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}

  # PRæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚³ãƒ¡ãƒ³ãƒˆ
  comment-preview-url:
    name: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚³ãƒ¡ãƒ³ãƒˆ
    needs: [deploy-preview]
    if: github.event_name == 'pull_request' && always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: PRã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸ” ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†

              ã“ã®PRã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒåˆ©ç”¨å¯èƒ½ã§ã™ï¼š
              ğŸŒ [ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URL](https://pr-${{ github.event.pull_request.number }}.automationa-tools.pages.dev)

              å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚`
            });
