name: ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼

# é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’åˆ¶å¾¡ã™ã‚‹ãƒ¡ã‚¤ãƒ³ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ãƒ¼
# PRæ™‚ã«ç¢ºå®Ÿã«å¿…è¦ãªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
on:
  pull_request:
    branches: [develop, main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'rules/**'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

# å®Ÿè¡Œã®æœ€é©åŒ–ï¼ˆåŒæ™‚å®Ÿè¡Œã‚’é˜²æ­¢ï¼‰
concurrency:
  group: orchestrator-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# workflow_dispatch APIã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®æ¨©é™è¨­å®š
permissions:
  contents: read
  pull-requests: write
  actions: write

jobs:
  # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’åˆ¶å¾¡
  trigger-workflows:
    name: ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'unit-tests.yml',
              ref: '${{ github.head_ref || github.ref_name }}'
            });
            console.log('ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');

      - name: çµ±åˆãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'integration-tests.yml',
              ref: '${{ github.head_ref || github.ref_name }}'
            });
            console.log('çµ±åˆãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');

      # PRã«ç‰¹å®šã®ãƒ©ãƒ™ãƒ«ãŒã‚ã‚‹å ´åˆã®ã¿E2Eãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œè¦å¦ç¢ºèª
        id: check-e2e
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          result-encoding: string
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const labels = pr.data.labels.map(label => label.name);
            return labels.includes('needs-e2e-tests') ? 'true' : 'false';

      - name: E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
        if: steps.check-e2e.outputs.result == 'true' || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'e2e-tests.yml',
              ref: '${{ github.head_ref || github.ref_name }}'
            });
            console.log('E2Eãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã—ã¾ã—ãŸ');

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒçŠ¶æ³ã®é€šçŸ¥
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const checkE2eResult = '${{ steps.check-e2e.outputs.result }}';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ãƒ†ã‚¹ãƒˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œé–‹å§‹ ğŸš€

              ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¾ã™:

              - âœ… ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
              - âœ… çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰
              ${checkE2eResult == 'true' ? '- âœ… E2Eãƒ†ã‚¹ãƒˆï¼ˆè‡ªå‹•å®Ÿè¡Œï¼‰' : '- â¸ï¸ E2Eãƒ†ã‚¹ãƒˆï¼ˆ"needs-e2e-tests"ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã¨å®Ÿè¡Œã•ã‚Œã¾ã™ï¼‰'}

              å„ãƒ†ã‚¹ãƒˆçµæœã¯å€‹åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã§å ±å‘Šã•ã‚Œã¾ã™ã€‚`
            });
